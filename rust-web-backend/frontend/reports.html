<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ¥å‘Šç”Ÿæˆ - åŒ»ç”ŸæŠ•æ”¾åˆ†æç³»ç»Ÿ</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .reports-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .report-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-type-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .report-type-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
            transform: translateY(-2px);
        }
        
        .report-type-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
        }
        
        .report-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .report-type-card h3 {
            margin: 0 0 12px 0;
            color: #495057;
        }
        
        .report-type-card p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        .report-config {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .config-section {
            margin-bottom: 24px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 24px;
        }
        
        .config-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .config-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #495057;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .filter-group {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .multi-select {
            min-height: 100px;
        }
        
        .range-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            align-items: center;
        }
        
        .range-inputs span {
            text-align: center;
            color: #6c757d;
        }
        
        .weight-config-selector {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .generate-section {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .generate-btn {
            background: white;
            color: #007bff;
            border: none;
            padding: 12px 32px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 8px;
        }
        
        .generate-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }
        
        .generate-btn:disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
            transform: none;
        }
        
        .export-options {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }
        
        .export-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .report-result {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }
        
        .report-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .report-title {
            font-size: 24px;
            font-weight: 600;
            color: #495057;
        }
        
        .report-meta {
            color: #6c757d;
            font-size: 14px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 8px;
        }
        
        .summary-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }
        
        .report-chart {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .ranking-table th {
            background: #007bff;
            color: white;
            font-weight: 600;
        }
        
        .ranking-table tr:hover {
            background: #f8f9fa;
        }
        
        .rank-number {
            width: 60px;
            text-align: center;
            font-weight: 700;
        }
        
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        .score-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .score-progress {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        
        .score-text {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .analysis-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .insight-item {
            background: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 4px solid #007bff;
        }
        
        .recommendation-item {
            background: #fff3cd;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 4px solid #ffc107;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 16px;
            border-radius: 6px;
            margin: 16px 0;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 16px;
            border-radius: 6px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="index.html">ğŸ“Š åŒ»ç”ŸæŠ•æ”¾åˆ†æç³»ç»Ÿ</a>
        </div>
        <div class="nav-menu">
            <a href="index.html">é¦–é¡µ</a>
            <a href="doctors.html">åŒ»ç”Ÿç®¡ç†</a>
            <a href="analysis.html">æ•°æ®åˆ†æ</a>
            <a href="import.html">æ•°æ®å¯¼å…¥</a>
            <a href="reports.html" class="active">æŠ¥å‘Šç”Ÿæˆ</a>
        </div>
    </nav>

    <div class="reports-container">
        <h1>ğŸ“ˆ æŠ¥å‘Šç”Ÿæˆ</h1>
        
        <!-- æŠ¥å‘Šç±»å‹é€‰æ‹© -->
        <div class="report-types">
            <div class="report-type-card" data-type="overview">
                <div class="report-icon">ğŸ“Š</div>
                <h3>æ¦‚è§ˆæŠ¥å‘Š</h3>
                <p>ç”Ÿæˆå…¨é¢çš„æ•°æ®æ¦‚è§ˆï¼ŒåŒ…æ‹¬ç»Ÿè®¡æ‘˜è¦ã€åˆ†å¸ƒåˆ†æå’Œå…³é”®æŒ‡æ ‡</p>
            </div>
            
            <div class="report-type-card" data-type="ranking">
                <div class="report-icon">ğŸ†</div>
                <h3>æ’åæŠ¥å‘Š</h3>
                <p>åŸºäºç»¼åˆè¯„åˆ†çš„åŒ»ç”Ÿæ’åï¼Œæ”¯æŒå¤šç»´åº¦è¯„åˆ†è¯¦æƒ…</p>
            </div>
            
            <div class="report-type-card" data-type="analysis">
                <div class="report-icon">ğŸ”</div>
                <h3>åˆ†ææŠ¥å‘Š</h3>
                <p>æ·±åº¦æ•°æ®åˆ†æï¼ŒåŒ…æ‹¬ç›¸å…³æ€§åˆ†æã€è¶‹åŠ¿é¢„æµ‹å’Œä¸šåŠ¡æ´å¯Ÿ</p>
            </div>
            
            <div class="report-type-card" data-type="comparison">
                <div class="report-icon">âš–ï¸</div>
                <h3>å¯¹æ¯”æŠ¥å‘Š</h3>
                <p>åŒ»ç”Ÿé—´çš„è¯¦ç»†å¯¹æ¯”åˆ†æï¼Œçªå‡ºä¼˜åŠ¿å’Œæ”¹è¿›ç©ºé—´</p>
            </div>
        </div>

        <!-- æŠ¥å‘Šé…ç½® -->
        <div class="report-config" id="report-config" style="display: none;">
            <!-- ç­›é€‰æ¡ä»¶ -->
            <div class="config-section">
                <div class="config-title">ğŸ“‹ ç­›é€‰æ¡ä»¶</div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>åœ°åŒº</label>
                        <select id="filter-regions" multiple class="multi-select">
                            <!-- åŠ¨æ€åŠ è½½é€‰é¡¹ -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ç§‘å®¤</label>
                        <select id="filter-departments" multiple class="multi-select">
                            <!-- åŠ¨æ€åŠ è½½é€‰é¡¹ -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>èŒç§°</label>
                        <select id="filter-titles" multiple class="multi-select">
                            <!-- åŠ¨æ€åŠ è½½é€‰é¡¹ -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>æœºæ„</label>
                        <select id="filter-institutions" multiple class="multi-select">
                            <!-- åŠ¨æ€åŠ è½½é€‰é¡¹ -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>è¯„åˆ†èŒƒå›´</label>
                        <div class="range-inputs">
                            <input type="number" id="score-min" placeholder="æœ€ä½åˆ†" min="0" max="100" step="0.1">
                            <span>-</span>
                            <input type="number" id="score-max" placeholder="æœ€é«˜åˆ†" min="0" max="100" step="0.1">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>ç²‰ä¸æ•°èŒƒå›´</label>
                        <div class="range-inputs">
                            <input type="number" id="fans-min" placeholder="æœ€å°‘ç²‰ä¸">
                            <span>-</span>
                            <input type="number" id="fans-max" placeholder="æœ€å¤šç²‰ä¸">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>ä»·æ ¼èŒƒå›´ (å…ƒ)</label>
                        <div class="range-inputs">
                            <input type="number" id="price-min" placeholder="æœ€ä½ä»·">
                            <span>-</span>
                            <input type="number" id="price-max" placeholder="æœ€é«˜ä»·">
                        </div>
                    </div>
                </div>
            </div>

            <!-- æƒé‡é…ç½® -->
            <div class="config-section">
                <div class="config-title">âš–ï¸ æƒé‡é…ç½®</div>
                <div class="weight-config-selector">
                    <label for="weight-config-select">é€‰æ‹©æƒé‡é…ç½®æ–¹æ¡ˆï¼š</label>
                    <select id="weight-config-select">
                        <option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>
                        <!-- åŠ¨æ€åŠ è½½æƒé‡é…ç½® -->
                    </select>
                </div>
            </div>

            <!-- è‡ªå®šä¹‰å­—æ®µ -->
            <div class="config-section">
                <div class="config-title">ğŸ¯ è‡ªå®šä¹‰é€‰é¡¹</div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>åŒ…å«å­—æ®µ</label>
                        <select id="custom-fields" multiple class="multi-select">
                            <option value="cost_efficiency">æ€§ä»·æ¯”åˆ†æ</option>
                            <option value="growth_metrics">å¢é•¿æŒ‡æ ‡</option>
                            <option value="engagement_rate">äº’åŠ¨ç‡</option>
                            <option value="regional_rank">åœ°åŒºæ’å</option>
                            <option value="department_rank">ç§‘å®¤æ’å</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>æŠ¥å‘Šæ ¼å¼</label>
                        <select id="export-format">
                            <option value="json">JSON (åœ¨çº¿æŸ¥çœ‹)</option>
                            <option value="csv">CSV (è¡¨æ ¼å¯¼å‡º)</option>
                            <option value="pdf">PDF (æš‚æœªæ”¯æŒ)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç”ŸæˆæŠ¥å‘Š -->
        <div class="generate-section" id="generate-section" style="display: none;">
            <h2>ğŸš€ ç”ŸæˆæŠ¥å‘Š</h2>
            <p>ç‚¹å‡»ä¸‹æ–¹æŒ‰é’®ç”Ÿæˆé€‰å®šç±»å‹çš„æŠ¥å‘Š</p>
            
            <button class="generate-btn" id="generate-btn" onclick="generateReport()">
                ğŸ“Š ç”ŸæˆæŠ¥å‘Š
            </button>
            
            <div class="export-options">
                <button class="export-btn" onclick="exportReport('csv')">ğŸ“Š å¯¼å‡º CSV</button>
                <button class="export-btn" onclick="exportReport('pdf')">ğŸ“„ å¯¼å‡º PDF</button>
                <button class="export-btn" onclick="shareReport()">ğŸ”— åˆ†äº«æŠ¥å‘Š</button>
            </div>
        </div>

        <!-- æŠ¥å‘Šç»“æœ -->
        <div class="report-result" id="report-result" style="display: none;">
            <!-- åŠ¨æ€ç”ŸæˆæŠ¥å‘Šå†…å®¹ -->
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let selectedReportType = null;
        let currentReport = null;
        let weightConfigs = [];

        // åˆå§‹åŒ–
        document.addEventListener('DOMContentLoaded', function() {
            setupReportTypeSelection();
            loadFilterOptions();
            loadWeightConfigs();
        });

        // è®¾ç½®æŠ¥å‘Šç±»å‹é€‰æ‹©
        function setupReportTypeSelection() {
            const reportCards = document.querySelectorAll('.report-type-card');
            
            reportCards.forEach(card => {
                card.addEventListener('click', function() {
                    reportCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    selectedReportType = this.dataset.type;
                    showReportConfig();
                });
            });
        }

        // æ˜¾ç¤ºæŠ¥å‘Šé…ç½®
        function showReportConfig() {
            document.getElementById('report-config').style.display = 'block';
            document.getElementById('generate-section').style.display = 'block';
            
            // æ»šåŠ¨åˆ°é…ç½®åŒºåŸŸ
            document.getElementById('report-config').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // åŠ è½½ç­›é€‰é€‰é¡¹
        async function loadFilterOptions() {
            try {
                // åŠ è½½åŒ»ç”Ÿæ•°æ®ä»¥è·å–ç­›é€‰é€‰é¡¹
                const response = await fetch('/api/doctors');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const doctors = result.data;
                    
                    // æå–å”¯ä¸€å€¼
                    const regions = [...new Set(doctors.map(d => d.region))].sort();
                    const departments = [...new Set(doctors.map(d => d.department))].sort();
                    const titles = [...new Set(doctors.map(d => d.title))].sort();
                    const institutions = [...new Set(doctors.map(d => d.institution).filter(Boolean))].sort();
                    
                    // å¡«å……é€‰æ‹©æ¡†
                    populateSelect('filter-regions', regions);
                    populateSelect('filter-departments', departments);
                    populateSelect('filter-titles', titles);
                    populateSelect('filter-institutions', institutions);
                }
            } catch (error) {
                console.error('åŠ è½½ç­›é€‰é€‰é¡¹å¤±è´¥:', error);
            }
        }

        // å¡«å……ä¸‹æ‹‰é€‰æ‹©æ¡†
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // åŠ è½½æƒé‡é…ç½®
        async function loadWeightConfigs() {
            try {
                const response = await fetch('/api/weight-configs');
                const result = await response.json();
                
                if (result.success && result.data) {
                    weightConfigs = result.data;
                    
                    const select = document.getElementById('weight-config-select');
                    select.innerHTML = '<option value="">ä½¿ç”¨é»˜è®¤é…ç½®</option>';
                    
                    weightConfigs.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.id;
                        option.textContent = config.name + (config.is_default ? ' (é»˜è®¤)' : '');
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('åŠ è½½æƒé‡é…ç½®å¤±è´¥:', error);
            }
        }

        // ç”ŸæˆæŠ¥å‘Š
        async function generateReport() {
            if (!selectedReportType) {
                showError('è¯·å…ˆé€‰æ‹©æŠ¥å‘Šç±»å‹');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="loading-spinner"></div> æ­£åœ¨ç”Ÿæˆ...';

            try {
                // æ”¶é›†ç­›é€‰æ¡ä»¶
                const filters = collectFilters();
                
                // æ„å»ºè¯·æ±‚æ•°æ®
                const requestData = {
                    report_type: selectedReportType,
                    filters: filters,
                    weight_config_id: parseInt(document.getElementById('weight-config-select').value) || null,
                    export_format: document.getElementById('export-format').value,
                    custom_fields: Array.from(document.getElementById('custom-fields').selectedOptions).map(o => o.value)
                };

                // å‘é€è¯·æ±‚
                const endpoint = getReportEndpoint(selectedReportType);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const report = await response.json();
                
                if (response.ok) {
                    currentReport = report;
                    displayReport(report);
                    showSuccess('æŠ¥å‘Šç”ŸæˆæˆåŠŸï¼');
                } else {
                    throw new Error(report.message || 'ç”ŸæˆæŠ¥å‘Šå¤±è´¥');
                }
            } catch (error) {
                showError('ç”ŸæˆæŠ¥å‘Šå¤±è´¥: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'ğŸ“Š ç”ŸæˆæŠ¥å‘Š';
            }
        }

        // è·å–æŠ¥å‘Šç«¯ç‚¹
        function getReportEndpoint(reportType) {
            const endpoints = {
                'overview': '/api/reports/overview',
                'ranking': '/api/reports/ranking',
                'analysis': '/api/reports/analysis',
                'comparison': '/api/reports/comparison'
            };
            return endpoints[reportType] || '/api/reports/overview';
        }

        // æ”¶é›†ç­›é€‰æ¡ä»¶
        function collectFilters() {
            const filters = {};
            
            // å¤šé€‰å­—æ®µ
            const multiSelects = ['regions', 'departments', 'titles', 'institutions'];
            multiSelects.forEach(field => {
                const selectElement = document.getElementById(`filter-${field}`);
                const selectedValues = Array.from(selectElement.selectedOptions).map(o => o.value);
                if (selectedValues.length > 0) {
                    filters[field] = selectedValues;
                }
            });
            
            // è¯„åˆ†èŒƒå›´
            const scoreMin = document.getElementById('score-min').value;
            const scoreMax = document.getElementById('score-max').value;
            if (scoreMin || scoreMax) {
                filters.score_range = {
                    min: scoreMin ? parseFloat(scoreMin) : null,
                    max: scoreMax ? parseFloat(scoreMax) : null
                };
            }
            
            // ç²‰ä¸æ•°èŒƒå›´
            const fansMin = document.getElementById('fans-min').value;
            const fansMax = document.getElementById('fans-max').value;
            if (fansMin || fansMax) {
                filters.fans_range = {
                    min: fansMin ? parseInt(fansMin) : null,
                    max: fansMax ? parseInt(fansMax) : null
                };
            }
            
            // ä»·æ ¼èŒƒå›´
            const priceMin = document.getElementById('price-min').value;
            const priceMax = document.getElementById('price-max').value;
            if (priceMin || priceMax) {
                filters.price_range = {
                    min: priceMin ? parseInt(priceMin) * 100 : null, // è½¬æ¢ä¸ºåˆ†
                    max: priceMax ? parseInt(priceMax) * 100 : null
                };
            }
            
            return Object.keys(filters).length > 0 ? filters : null;
        }

        // æ˜¾ç¤ºæŠ¥å‘Š
        function displayReport(report) {
            const resultContainer = document.getElementById('report-result');
            resultContainer.style.display = 'block';
            
            let html = '';
            
            // æŠ¥å‘Šå¤´éƒ¨
            html += `
                <div class="report-header">
                    <div>
                        <div class="report-title">${getReportTitle(report.report_type)}</div>
                        <div class="report-meta">
                            æŠ¥å‘ŠID: ${report.report_id} | 
                            ç”Ÿæˆæ—¶é—´: ${new Date(report.generated_at).toLocaleString()} |
                            ç”Ÿæˆè€—æ—¶: ${report.metadata.generation_time_ms}ms
                        </div>
                    </div>
                </div>
            `;
            
            // æ ¹æ®æŠ¥å‘Šç±»å‹æ˜¾ç¤ºå†…å®¹
            switch (report.report_type) {
                case 'overview':
                    html += renderOverviewReport(report);
                    break;
                case 'ranking':
                    html += renderRankingReport(report);
                    break;
                case 'analysis':
                    html += renderAnalysisReport(report);
                    break;
                default:
                    html += '<p>æš‚ä¸æ”¯æŒæ­¤æŠ¥å‘Šç±»å‹çš„æ˜¾ç¤º</p>';
            }
            
            resultContainer.innerHTML = html;
            
            // æ»šåŠ¨åˆ°ç»“æœåŒºåŸŸ
            resultContainer.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // æ¸²æŸ“æ¦‚è§ˆæŠ¥å‘Š
        function renderOverviewReport(report) {
            const summary = report.data.summary;
            if (!summary) return '<p>æš‚æ— æ¦‚è§ˆæ•°æ®</p>';
            
            let html = '';
            
            // æ‘˜è¦å¡ç‰‡
            html += `
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-value">${summary.total_doctors}</div>
                        <div class="summary-label">åŒ»ç”Ÿæ€»æ•°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.regions_count}</div>
                        <div class="summary-label">è¦†ç›–åœ°åŒº</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.departments_count}</div>
                        <div class="summary-label">æ¶‰åŠç§‘å®¤</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.avg_score.toFixed(1)}</div>
                        <div class="summary-label">å¹³å‡è¯„åˆ†</div>
                    </div>
                </div>
            `;
            
            // ä»·æ ¼ç»Ÿè®¡
            html += `
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-value">Â¥${(summary.price_stats.avg_price / 100).toFixed(0)}</div>
                        <div class="summary-label">å¹³å‡ä»·æ ¼</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">Â¥${(summary.price_stats.median_price / 100).toFixed(0)}</div>
                        <div class="summary-label">ä¸­ä½ä»·æ ¼</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${(summary.engagement_stats.total_fans / 10000).toFixed(1)}ä¸‡</div>
                        <div class="summary-label">æ€»ç²‰ä¸æ•°</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.engagement_stats.avg_engagement_rate.toFixed(1)}%</div>
                        <div class="summary-label">å¹³å‡äº’åŠ¨ç‡</div>
                    </div>
                </div>
            `;
            
            // æ’è¡Œæ¦œ
            if (summary.top_regions && summary.top_regions.length > 0) {
                html += '<h3>ğŸ† åœ°åŒºæ’è¡Œæ¦œ</h3>';
                html += '<table class="ranking-table">';
                html += '<thead><tr><th>æ’å</th><th>åœ°åŒº</th><th>åŒ»ç”Ÿæ•°é‡</th><th>å¹³å‡è¯„åˆ†</th><th>å¹³å‡ä»·æ ¼</th></tr></thead>';
                html += '<tbody>';
                
                summary.top_regions.slice(0, 10).forEach((region, index) => {
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    html += `
                        <tr>
                            <td class="rank-number ${rankClass}">${index + 1}</td>
                            <td>${region.region}</td>
                            <td>${region.doctor_count}</td>
                            <td>${region.avg_score.toFixed(1)}</td>
                            <td>Â¥${(region.avg_price / 100).toFixed(0)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            return html;
        }

        // æ¸²æŸ“æ’åæŠ¥å‘Š
        function renderRankingReport(report) {
            const rankings = report.data.rankings;
            if (!rankings || rankings.length === 0) {
                return '<p>æš‚æ— æ’åæ•°æ®</p>';
            }
            
            let html = `
                <h3>ğŸ† åŒ»ç”Ÿç»¼åˆæ’å (Top ${Math.min(rankings.length, 50)})</h3>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>æ’å</th>
                            <th>åŒ»ç”Ÿ</th>
                            <th>åœ°åŒº</th>
                            <th>ç§‘å®¤</th>
                            <th>ç²‰ä¸æ•°</th>
                            <th>ç»¼åˆè¯„åˆ†</th>
                            <th>è¯„åˆ†æ„æˆ</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rankings.slice(0, 50).forEach(ranking => {
                const doctor = ranking.doctor.doctor;
                const score = ranking.doctor.comprehensive_score;
                const components = ranking.score_components;
                const rankClass = ranking.rank <= 3 ? `rank-${ranking.rank}` : '';
                
                html += `
                    <tr>
                        <td class="rank-number ${rankClass}">${ranking.rank}</td>
                        <td>
                            <strong>${doctor.name}</strong><br>
                            <small>${doctor.title}</small>
                        </td>
                        <td>${doctor.region}</td>
                        <td>${doctor.department}</td>
                        <td>${doctor.total_fans.toLocaleString()}</td>
                        <td>
                            <div class="score-bar">
                                <div class="score-progress">
                                    <div class="score-fill" style="width: ${score}%"></div>
                                </div>
                                <div class="score-text">${score.toFixed(1)}</div>
                            </div>
                        </td>
                        <td>
                            <small>
                                å½±å“åŠ›: ${components.influence_score.toFixed(1)}<br>
                                è´¨é‡: ${components.quality_score.toFixed(1)}
                            </small>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        // æ¸²æŸ“åˆ†ææŠ¥å‘Š
        function renderAnalysisReport(report) {
            const analysis = report.data.analysis;
            if (!analysis) return '<p>æš‚æ— åˆ†ææ•°æ®</p>';
            
            let html = '';
            
            // ç›¸å…³æ€§åˆ†æ
            if (analysis.correlations && analysis.correlations.length > 0) {
                html += '<div class="analysis-section">';
                html += '<h3>ğŸ“Š ç›¸å…³æ€§åˆ†æ</h3>';
                
                analysis.correlations.forEach(corr => {
                    const strength = Math.abs(corr.correlation);
                    const strengthText = strength > 0.7 ? 'å¼ºç›¸å…³' : strength > 0.3 ? 'ä¸­ç­‰ç›¸å…³' : 'å¼±ç›¸å…³';
                    const color = strength > 0.7 ? '#28a745' : strength > 0.3 ? '#ffc107' : '#6c757d';
                    
                    html += `
                        <div class="insight-item">
                            <strong>${corr.factor1} vs ${corr.factor2}</strong>
                            <div style="color: ${color}; font-weight: 600;">
                                ç›¸å…³ç³»æ•°: ${corr.correlation.toFixed(3)} (${strengthText})
                            </div>
                            <p>${corr.description}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // ä¸šåŠ¡æ´å¯Ÿ
            if (analysis.insights && analysis.insights.length > 0) {
                html += '<div class="analysis-section">';
                html += '<h3>ğŸ’¡ ä¸šåŠ¡æ´å¯Ÿ</h3>';
                
                analysis.insights.forEach(insight => {
                    html += `<div class="insight-item">ğŸ“ˆ ${insight}</div>`;
                });
                
                html += '</div>';
            }
            
            // å»ºè®®
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                html += '<div class="analysis-section">';
                html += '<h3>ğŸ’¼ ä¸šåŠ¡å»ºè®®</h3>';
                
                analysis.recommendations.forEach(recommendation => {
                    html += `<div class="recommendation-item">ğŸ’¡ ${recommendation}</div>`;
                });
                
                html += '</div>';
            }
            
            return html;
        }

        // è·å–æŠ¥å‘Šæ ‡é¢˜
        function getReportTitle(reportType) {
            const titles = {
                'overview': 'ğŸ“Š æ•°æ®æ¦‚è§ˆæŠ¥å‘Š',
                'ranking': 'ğŸ† åŒ»ç”Ÿæ’åæŠ¥å‘Š',
                'analysis': 'ğŸ” æ·±åº¦åˆ†ææŠ¥å‘Š',
                'comparison': 'âš–ï¸ å¯¹æ¯”åˆ†ææŠ¥å‘Š'
            };
            return titles[reportType] || 'ğŸ“ˆ åˆ†ææŠ¥å‘Š';
        }

        // å¯¼å‡ºæŠ¥å‘Š
        async function exportReport(format) {
            if (!currentReport) {
                showError('è¯·å…ˆç”ŸæˆæŠ¥å‘Š');
                return;
            }

            try {
                if (format === 'csv') {
                    const filters = collectFilters();
                    const requestData = {
                        report_type: selectedReportType,
                        filters: filters,
                        weight_config_id: parseInt(document.getElementById('weight-config-select').value) || null,
                        export_format: 'csv'
                    };

                    const response = await fetch('/api/reports/export/csv', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `report_${selectedReportType}_${new Date().toISOString().slice(0, 10)}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        showSuccess('CSV æŠ¥å‘Šå¯¼å‡ºæˆåŠŸï¼');
                    } else {
                        throw new Error('å¯¼å‡ºå¤±è´¥');
                    }
                } else if (format === 'pdf') {
                    showError('PDF å¯¼å‡ºåŠŸèƒ½å³å°†æ¨å‡º');
                } else {
                    // JSON æ ¼å¼
                    const dataStr = JSON.stringify(currentReport, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `report_${selectedReportType}_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showSuccess('JSON æŠ¥å‘Šå¯¼å‡ºæˆåŠŸï¼');
                }
            } catch (error) {
                showError('å¯¼å‡ºå¤±è´¥: ' + error.message);
            }
        }

        // åˆ†äº«æŠ¥å‘Š
        function shareReport() {
            if (!currentReport) {
                showError('è¯·å…ˆç”ŸæˆæŠ¥å‘Š');
                return;
            }

            // ç”Ÿæˆåˆ†äº«é“¾æ¥ (è¿™é‡Œåªæ˜¯ç¤ºä¾‹)
            const shareUrl = `${window.location.origin}/reports.html?report=${currentReport.report_id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'åŒ»ç”ŸæŠ•æ”¾åˆ†ææŠ¥å‘Š',
                    text: `æŸ¥çœ‹${getReportTitle(currentReport.report_type)}`,
                    url: shareUrl
                });
            } else {
                // å¤åˆ¶åˆ°å‰ªè´´æ¿
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showSuccess('åˆ†äº«é“¾æ¥å·²å¤åˆ¶åˆ°å‰ªè´´æ¿ï¼');
                }).catch(() => {
                    prompt('å¤åˆ¶åˆ†äº«é“¾æ¥:', shareUrl);
                });
            }
        }

        // å·¥å…·å‡½æ•°
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.reports-container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const container = document.querySelector('.reports-container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
