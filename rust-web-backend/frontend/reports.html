<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Êä•ÂëäÁîüÊàê - ÂåªÁîüÊäïÊîæÂàÜÊûêÁ≥ªÁªü</title>
    <link rel="stylesheet" href="styles.css">
    <style>
        .reports-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .report-types {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .report-type-card {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 2px solid #e9ecef;
            cursor: pointer;
            transition: all 0.3s ease;
            text-align: center;
        }
        
        .report-type-card:hover {
            border-color: #007bff;
            box-shadow: 0 4px 12px rgba(0,123,255,0.15);
            transform: translateY(-2px);
        }
        
        .report-type-card.selected {
            border-color: #007bff;
            background: #f8f9ff;
        }
        
        .report-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }
        
        .report-type-card h3 {
            margin: 0 0 12px 0;
            color: #495057;
        }
        
        .report-type-card p {
            margin: 0;
            color: #6c757d;
            font-size: 14px;
        }
        
        .report-config {
            background: white;
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 20px;
            border: 1px solid #dee2e6;
        }
        
        .config-section {
            margin-bottom: 24px;
            border-bottom: 1px solid #e9ecef;
            padding-bottom: 24px;
        }
        
        .config-section:last-child {
            border-bottom: none;
            margin-bottom: 0;
            padding-bottom: 0;
        }
        
        .config-title {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 16px;
            color: #495057;
        }
        
        .filter-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 16px;
        }
        
        .filter-group {
            background: #f8f9fa;
            padding: 16px;
            border-radius: 8px;
        }
        
        .filter-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #495057;
        }
        
        .filter-group select,
        .filter-group input {
            width: 100%;
            padding: 8px 12px;
            border: 1px solid #ced4da;
            border-radius: 4px;
            font-size: 14px;
        }
        
        .multi-select {
            min-height: 100px;
        }
        
        .range-inputs {
            display: grid;
            grid-template-columns: 1fr auto 1fr;
            gap: 8px;
            align-items: center;
        }
        
        .range-inputs span {
            text-align: center;
            color: #6c757d;
        }
        
        .weight-config-selector {
            background: #fff3cd;
            border: 1px solid #ffeaa7;
            border-radius: 8px;
            padding: 16px;
            margin-bottom: 16px;
        }
        
        .generate-section {
            background: linear-gradient(135deg, #007bff, #0056b3);
            color: white;
            border-radius: 12px;
            padding: 24px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .generate-btn {
            background: white;
            color: #007bff;
            border: none;
            padding: 12px 32px;
            border-radius: 6px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin: 0 8px;
        }
        
        .generate-btn:hover {
            background: #f8f9fa;
            transform: translateY(-1px);
        }
        
        .generate-btn:disabled {
            background: #6c757d;
            color: white;
            cursor: not-allowed;
            transform: none;
        }
        
        .export-options {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 16px;
        }
        
        .export-btn {
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            padding: 8px 16px;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.3s ease;
        }
        
        .export-btn:hover {
            background: rgba(255,255,255,0.3);
        }
        
        .report-result {
            background: white;
            border-radius: 12px;
            padding: 24px;
            border: 1px solid #dee2e6;
            margin-top: 20px;
        }
        
        .report-header {
            display: flex;
            justify-content: between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 2px solid #e9ecef;
        }
        
        .report-title {
            font-size: 24px;
            font-weight: 600;
            color: #495057;
        }
        
        .report-meta {
            color: #6c757d;
            font-size: 14px;
        }
        
        .summary-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 16px;
            margin-bottom: 24px;
        }
        
        .summary-card {
            background: linear-gradient(135deg, #f8f9fa, #e9ecef);
            padding: 20px;
            border-radius: 8px;
            text-align: center;
            border: 1px solid #dee2e6;
        }
        
        .summary-value {
            font-size: 32px;
            font-weight: 700;
            color: #007bff;
            margin-bottom: 8px;
        }
        
        .summary-label {
            color: #6c757d;
            font-size: 14px;
            font-weight: 500;
        }
        
        .report-chart {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
            text-align: center;
            min-height: 300px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #6c757d;
        }
        
        .ranking-table {
            width: 100%;
            border-collapse: collapse;
            margin-bottom: 24px;
            background: white;
            border-radius: 8px;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .ranking-table th,
        .ranking-table td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #dee2e6;
        }
        
        .ranking-table th {
            background: #007bff;
            color: white;
            font-weight: 600;
        }
        
        .ranking-table tr:hover {
            background: #f8f9fa;
        }
        
        .rank-number {
            width: 60px;
            text-align: center;
            font-weight: 700;
        }
        
        .rank-1 { color: #ffd700; }
        .rank-2 { color: #c0c0c0; }
        .rank-3 { color: #cd7f32; }
        
        .score-bar {
            display: flex;
            align-items: center;
            gap: 8px;
        }
        
        .score-progress {
            flex: 1;
            height: 20px;
            background: #e9ecef;
            border-radius: 10px;
            overflow: hidden;
        }
        
        .score-fill {
            height: 100%;
            background: linear-gradient(90deg, #28a745, #20c997);
            transition: width 0.3s ease;
        }
        
        .score-text {
            font-weight: 600;
            min-width: 60px;
            text-align: center;
        }
        
        .analysis-section {
            background: #f8f9fa;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 24px;
        }
        
        .insight-item {
            background: white;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 4px solid #007bff;
        }
        
        .recommendation-item {
            background: #fff3cd;
            padding: 16px;
            border-radius: 6px;
            margin-bottom: 12px;
            border-left: 4px solid #ffc107;
        }
        
        .loading-spinner {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #007bff;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 20px auto;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        .error-message {
            background: #f8d7da;
            border: 1px solid #f5c6cb;
            color: #721c24;
            padding: 16px;
            border-radius: 6px;
            margin: 16px 0;
        }
        
        .success-message {
            background: #d4edda;
            border: 1px solid #c3e6cb;
            color: #155724;
            padding: 16px;
            border-radius: 6px;
            margin: 16px 0;
        }
    </style>
</head>
<body>
    <nav class="navbar">
        <div class="nav-brand">
            <a href="index.html">üìä ÂåªÁîüÊäïÊîæÂàÜÊûêÁ≥ªÁªü</a>
        </div>
        <div class="nav-menu">
            <a href="index.html">È¶ñÈ°µ</a>
            <a href="doctors.html">ÂåªÁîüÁÆ°ÁêÜ</a>
            <a href="analysis.html">Êï∞ÊçÆÂàÜÊûê</a>
            <a href="import.html">Êï∞ÊçÆÂØºÂÖ•</a>
            <a href="reports.html" class="active">Êä•ÂëäÁîüÊàê</a>
        </div>
    </nav>

    <div class="reports-container">
        <h1>üìà Êä•ÂëäÁîüÊàê</h1>
        
        <!-- Êä•ÂëäÁ±ªÂûãÈÄâÊã© -->
        <div class="report-types">
            <div class="report-type-card" data-type="overview">
                <div class="report-icon">üìä</div>
                <h3>Ê¶ÇËßàÊä•Âëä</h3>
                <p>ÁîüÊàêÂÖ®Èù¢ÁöÑÊï∞ÊçÆÊ¶ÇËßàÔºåÂåÖÊã¨ÁªüËÆ°ÊëòË¶Å„ÄÅÂàÜÂ∏ÉÂàÜÊûêÂíåÂÖ≥ÈîÆÊåáÊ†á</p>
            </div>
            
            <div class="report-type-card" data-type="ranking">
                <div class="report-icon">üèÜ</div>
                <h3>ÊéíÂêçÊä•Âëä</h3>
                <p>Âü∫‰∫éÁªºÂêàËØÑÂàÜÁöÑÂåªÁîüÊéíÂêçÔºåÊîØÊåÅÂ§öÁª¥Â∫¶ËØÑÂàÜËØ¶ÊÉÖ</p>
            </div>
            
            <div class="report-type-card" data-type="analysis">
                <div class="report-icon">üîç</div>
                <h3>ÂàÜÊûêÊä•Âëä</h3>
                <p>Ê∑±Â∫¶Êï∞ÊçÆÂàÜÊûêÔºåÂåÖÊã¨Áõ∏ÂÖ≥ÊÄßÂàÜÊûê„ÄÅË∂ãÂäøÈ¢ÑÊµãÂíå‰∏öÂä°Ê¥ûÂØü</p>
            </div>
            
            <div class="report-type-card" data-type="comparison">
                <div class="report-icon">‚öñÔ∏è</div>
                <h3>ÂØπÊØîÊä•Âëä</h3>
                <p>ÂåªÁîüÈó¥ÁöÑËØ¶ÁªÜÂØπÊØîÂàÜÊûêÔºåÁ™ÅÂá∫‰ºòÂäøÂíåÊîπËøõÁ©∫Èó¥</p>
            </div>
        </div>

        <!-- Êä•ÂëäÈÖçÁΩÆ -->
        <div class="report-config" id="report-config" style="display: none;">
            <!-- Á≠õÈÄâÊù°‰ª∂ -->
            <div class="config-section">
                <div class="config-title">üìã Á≠õÈÄâÊù°‰ª∂</div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>Âú∞Âå∫</label>
                        <select id="filter-regions" multiple class="multi-select">
                            <!-- Âä®ÊÄÅÂä†ËΩΩÈÄâÈ°π -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ÁßëÂÆ§</label>
                        <select id="filter-departments" multiple class="multi-select">
                            <!-- Âä®ÊÄÅÂä†ËΩΩÈÄâÈ°π -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ËÅåÁß∞</label>
                        <select id="filter-titles" multiple class="multi-select">
                            <!-- Âä®ÊÄÅÂä†ËΩΩÈÄâÈ°π -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Êú∫ÊûÑ</label>
                        <select id="filter-institutions" multiple class="multi-select">
                            <!-- Âä®ÊÄÅÂä†ËΩΩÈÄâÈ°π -->
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>ËØÑÂàÜËåÉÂõ¥</label>
                        <div class="range-inputs">
                            <input type="number" id="score-min" placeholder="ÊúÄ‰ΩéÂàÜ" min="0" max="100" step="0.1">
                            <span>-</span>
                            <input type="number" id="score-max" placeholder="ÊúÄÈ´òÂàÜ" min="0" max="100" step="0.1">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>Á≤â‰∏ùÊï∞ËåÉÂõ¥</label>
                        <div class="range-inputs">
                            <input type="number" id="fans-min" placeholder="ÊúÄÂ∞ëÁ≤â‰∏ù">
                            <span>-</span>
                            <input type="number" id="fans-max" placeholder="ÊúÄÂ§öÁ≤â‰∏ù">
                        </div>
                    </div>
                    
                    <div class="filter-group">
                        <label>‰ª∑Ê†ºËåÉÂõ¥ (ÂÖÉ)</label>
                        <div class="range-inputs">
                            <input type="number" id="price-min" placeholder="ÊúÄ‰Ωé‰ª∑">
                            <span>-</span>
                            <input type="number" id="price-max" placeholder="ÊúÄÈ´ò‰ª∑">
                        </div>
                    </div>
                </div>
            </div>

            <!-- ÊùÉÈáçÈÖçÁΩÆ -->
            <div class="config-section">
                <div class="config-title">‚öñÔ∏è ÊùÉÈáçÈÖçÁΩÆ</div>
                <div class="weight-config-selector">
                    <label for="weight-config-select">ÈÄâÊã©ÊùÉÈáçÈÖçÁΩÆÊñπÊ°àÔºö</label>
                    <select id="weight-config-select">
                        <option value="">‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ</option>
                        <!-- Âä®ÊÄÅÂä†ËΩΩÊùÉÈáçÈÖçÁΩÆ -->
                    </select>
                </div>
            </div>

            <!-- Ëá™ÂÆö‰πâÂ≠óÊÆµ -->
            <div class="config-section">
                <div class="config-title">üéØ Ëá™ÂÆö‰πâÈÄâÈ°π</div>
                <div class="filter-grid">
                    <div class="filter-group">
                        <label>ÂåÖÂê´Â≠óÊÆµ</label>
                        <select id="custom-fields" multiple class="multi-select">
                            <option value="cost_efficiency">ÊÄß‰ª∑ÊØîÂàÜÊûê</option>
                            <option value="growth_metrics">Â¢ûÈïøÊåáÊ†á</option>
                            <option value="engagement_rate">‰∫íÂä®Áéá</option>
                            <option value="regional_rank">Âú∞Âå∫ÊéíÂêç</option>
                            <option value="department_rank">ÁßëÂÆ§ÊéíÂêç</option>
                        </select>
                    </div>
                    
                    <div class="filter-group">
                        <label>Êä•ÂëäÊ†ºÂºè</label>
                        <select id="export-format">
                            <option value="json">JSON (Âú®Á∫øÊü•Áúã)</option>
                            <option value="csv">CSV (Ë°®Ê†ºÂØºÂá∫)</option>
                            <option value="pdf">PDF (ÊöÇÊú™ÊîØÊåÅ)</option>
                        </select>
                    </div>
                </div>
            </div>
        </div>

        <!-- ÁîüÊàêÊä•Âëä -->
        <div class="generate-section" id="generate-section" style="display: none;">
            <h2>üöÄ ÁîüÊàêÊä•Âëä</h2>
            <p>ÁÇπÂáª‰∏ãÊñπÊåâÈíÆÁîüÊàêÈÄâÂÆöÁ±ªÂûãÁöÑÊä•Âëä</p>
            
            <button class="generate-btn" id="generate-btn" onclick="generateReport()">
                üìä ÁîüÊàêÊä•Âëä
            </button>
            
            <div class="export-options">
                <button class="export-btn" onclick="exportReport('csv')">üìä ÂØºÂá∫ CSV</button>
                <button class="export-btn" onclick="exportReport('pdf')">üìÑ ÂØºÂá∫ PDF</button>
                <button class="export-btn" onclick="shareReport()">üîó ÂàÜ‰∫´Êä•Âëä</button>
            </div>
        </div>

        <!-- Êä•ÂëäÁªìÊûú -->
        <div class="report-result" id="report-result" style="display: none;">
            <!-- Âä®ÊÄÅÁîüÊàêÊä•ÂëäÂÜÖÂÆπ -->
        </div>
    </div>

    <script src="common.js"></script>
    <script>
        let selectedReportType = null;
        let currentReport = null;
        let weightConfigs = [];

        // ÂàùÂßãÂåñ
        document.addEventListener('DOMContentLoaded', function() {
            setupReportTypeSelection();
            loadFilterOptions();
            loadWeightConfigs();
        });

        // ËÆæÁΩÆÊä•ÂëäÁ±ªÂûãÈÄâÊã©
        function setupReportTypeSelection() {
            const reportCards = document.querySelectorAll('.report-type-card');
            
            reportCards.forEach(card => {
                card.addEventListener('click', function() {
                    reportCards.forEach(c => c.classList.remove('selected'));
                    this.classList.add('selected');
                    
                    selectedReportType = this.dataset.type;
                    showReportConfig();
                });
            });
        }

        // ÊòæÁ§∫Êä•ÂëäÈÖçÁΩÆ
        function showReportConfig() {
            document.getElementById('report-config').style.display = 'block';
            document.getElementById('generate-section').style.display = 'block';
            
            // ÊªöÂä®Âà∞ÈÖçÁΩÆÂå∫Âüü
            document.getElementById('report-config').scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Âä†ËΩΩÁ≠õÈÄâÈÄâÈ°π
        async function loadFilterOptions() {
            try {
                // Âä†ËΩΩÂåªÁîüÊï∞ÊçÆ‰ª•Ëé∑ÂèñÁ≠õÈÄâÈÄâÈ°π
                const response = await fetch('/api/doctors');
                const result = await response.json();
                
                if (result.success && result.data) {
                    const doctors = result.data;
                    
                    // ÊèêÂèñÂîØ‰∏ÄÂÄº
                    const regions = [...new Set(doctors.map(d => d.region))].sort();
                    const departments = [...new Set(doctors.map(d => d.department))].sort();
                    const titles = [...new Set(doctors.map(d => d.title))].sort();
                    const institutions = [...new Set(doctors.map(d => d.institution).filter(Boolean))].sort();
                    
                    // Â°´ÂÖÖÈÄâÊã©Ê°Ü
                    populateSelect('filter-regions', regions);
                    populateSelect('filter-departments', departments);
                    populateSelect('filter-titles', titles);
                    populateSelect('filter-institutions', institutions);
                }
            } catch (error) {
                console.error('Âä†ËΩΩÁ≠õÈÄâÈÄâÈ°πÂ§±Ë¥•:', error);
            }
        }

        // Â°´ÂÖÖ‰∏ãÊãâÈÄâÊã©Ê°Ü
        function populateSelect(selectId, options) {
            const select = document.getElementById(selectId);
            select.innerHTML = '';
            
            options.forEach(option => {
                const optionElement = document.createElement('option');
                optionElement.value = option;
                optionElement.textContent = option;
                select.appendChild(optionElement);
            });
        }

        // Âä†ËΩΩÊùÉÈáçÈÖçÁΩÆ
        async function loadWeightConfigs() {
            try {
                const response = await fetch('/api/weight-configs');
                const result = await response.json();
                
                if (result.success && result.data) {
                    weightConfigs = result.data;
                    
                    const select = document.getElementById('weight-config-select');
                    select.innerHTML = '<option value="">‰ΩøÁî®ÈªòËÆ§ÈÖçÁΩÆ</option>';
                    
                    weightConfigs.forEach(config => {
                        const option = document.createElement('option');
                        option.value = config.id;
                        option.textContent = config.name + (config.is_default ? ' (ÈªòËÆ§)' : '');
                        select.appendChild(option);
                    });
                }
            } catch (error) {
                console.error('Âä†ËΩΩÊùÉÈáçÈÖçÁΩÆÂ§±Ë¥•:', error);
            }
        }

        // ÁîüÊàêÊä•Âëä
        async function generateReport() {
            if (!selectedReportType) {
                showError('ËØ∑ÂÖàÈÄâÊã©Êä•ÂëäÁ±ªÂûã');
                return;
            }

            const generateBtn = document.getElementById('generate-btn');
            generateBtn.disabled = true;
            generateBtn.innerHTML = '<div class="loading-spinner"></div> Ê≠£Âú®ÁîüÊàê...';

            try {
                // Êî∂ÈõÜÁ≠õÈÄâÊù°‰ª∂
                const filters = collectFilters();
                
                // ÊûÑÂª∫ËØ∑Ê±ÇÊï∞ÊçÆ
                const requestData = {
                    report_type: selectedReportType,
                    filters: filters,
                    weight_config_id: parseInt(document.getElementById('weight-config-select').value) || null,
                    export_format: document.getElementById('export-format').value,
                    custom_fields: Array.from(document.getElementById('custom-fields').selectedOptions).map(o => o.value)
                };

                // ÂèëÈÄÅËØ∑Ê±Ç
                const endpoint = getReportEndpoint(selectedReportType);
                const response = await fetch(endpoint, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(requestData)
                });

                const report = await response.json();
                
                if (response.ok) {
                    currentReport = report;
                    displayReport(report);
                    showSuccess('Êä•ÂëäÁîüÊàêÊàêÂäüÔºÅ');
                } else {
                    throw new Error(report.message || 'ÁîüÊàêÊä•ÂëäÂ§±Ë¥•');
                }
            } catch (error) {
                showError('ÁîüÊàêÊä•ÂëäÂ§±Ë¥•: ' + error.message);
            } finally {
                generateBtn.disabled = false;
                generateBtn.innerHTML = 'üìä ÁîüÊàêÊä•Âëä';
            }
        }

        // Ëé∑ÂèñÊä•ÂëäÁ´ØÁÇπ
        function getReportEndpoint(reportType) {
            const endpoints = {
                'overview': '/api/reports/overview',
                'ranking': '/api/reports/ranking',
                'analysis': '/api/reports/analysis',
                'comparison': '/api/reports/comparison'
            };
            return endpoints[reportType] || '/api/reports/overview';
        }

        // Êî∂ÈõÜÁ≠õÈÄâÊù°‰ª∂
        function collectFilters() {
            const filters = {};
            
            // Â§öÈÄâÂ≠óÊÆµ
            const multiSelects = ['regions', 'departments', 'titles', 'institutions'];
            multiSelects.forEach(field => {
                const selectElement = document.getElementById(`filter-${field}`);
                const selectedValues = Array.from(selectElement.selectedOptions).map(o => o.value);
                if (selectedValues.length > 0) {
                    filters[field] = selectedValues;
                }
            });
            
            // ËØÑÂàÜËåÉÂõ¥
            const scoreMin = document.getElementById('score-min').value;
            const scoreMax = document.getElementById('score-max').value;
            if (scoreMin || scoreMax) {
                filters.score_range = {
                    min: scoreMin ? parseFloat(scoreMin) : null,
                    max: scoreMax ? parseFloat(scoreMax) : null
                };
            }
            
            // Á≤â‰∏ùÊï∞ËåÉÂõ¥
            const fansMin = document.getElementById('fans-min').value;
            const fansMax = document.getElementById('fans-max').value;
            if (fansMin || fansMax) {
                filters.fans_range = {
                    min: fansMin ? parseInt(fansMin) : null,
                    max: fansMax ? parseInt(fansMax) : null
                };
            }
            
            // ‰ª∑Ê†ºËåÉÂõ¥
            const priceMin = document.getElementById('price-min').value;
            const priceMax = document.getElementById('price-max').value;
            if (priceMin || priceMax) {
                filters.price_range = {
                    min: priceMin ? parseInt(priceMin) * 100 : null, // ËΩ¨Êç¢‰∏∫ÂàÜ
                    max: priceMax ? parseInt(priceMax) * 100 : null
                };
            }
            
            return Object.keys(filters).length > 0 ? filters : null;
        }

        // ÊòæÁ§∫Êä•Âëä
        function displayReport(report) {
            const resultContainer = document.getElementById('report-result');
            resultContainer.style.display = 'block';
            
            let html = '';
            
            // Êä•ÂëäÂ§¥ÈÉ®
            html += `
                <div class="report-header">
                    <div>
                        <div class="report-title">${getReportTitle(report.report_type)}</div>
                        <div class="report-meta">
                            Êä•ÂëäID: ${report.report_id} | 
                            ÁîüÊàêÊó∂Èó¥: ${new Date(report.generated_at).toLocaleString()} |
                            ÁîüÊàêËÄóÊó∂: ${report.metadata.generation_time_ms}ms
                        </div>
                    </div>
                </div>
            `;
            
            // Ê†πÊçÆÊä•ÂëäÁ±ªÂûãÊòæÁ§∫ÂÜÖÂÆπ
            switch (report.report_type) {
                case 'overview':
                    html += renderOverviewReport(report);
                    break;
                case 'ranking':
                    html += renderRankingReport(report);
                    break;
                case 'analysis':
                    html += renderAnalysisReport(report);
                    break;
                default:
                    html += '<p>ÊöÇ‰∏çÊîØÊåÅÊ≠§Êä•ÂëäÁ±ªÂûãÁöÑÊòæÁ§∫</p>';
            }
            
            resultContainer.innerHTML = html;
            
            // ÊªöÂä®Âà∞ÁªìÊûúÂå∫Âüü
            resultContainer.scrollIntoView({ 
                behavior: 'smooth',
                block: 'start'
            });
        }

        // Ê∏≤ÊüìÊ¶ÇËßàÊä•Âëä
        function renderOverviewReport(report) {
            const summary = report.data.summary;
            if (!summary) return '<p>ÊöÇÊó†Ê¶ÇËßàÊï∞ÊçÆ</p>';
            
            let html = '';
            
            // ÊëòË¶ÅÂç°Áâá
            html += `
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-value">${summary.total_doctors}</div>
                        <div class="summary-label">ÂåªÁîüÊÄªÊï∞</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.regions_count}</div>
                        <div class="summary-label">Ë¶ÜÁõñÂú∞Âå∫</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.departments_count}</div>
                        <div class="summary-label">Ê∂âÂèäÁßëÂÆ§</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.avg_score.toFixed(1)}</div>
                        <div class="summary-label">Âπ≥ÂùáËØÑÂàÜ</div>
                    </div>
                </div>
            `;
            
            // ‰ª∑Ê†ºÁªüËÆ°
            html += `
                <div class="summary-cards">
                    <div class="summary-card">
                        <div class="summary-value">¬•${(summary.price_stats.avg_price / 100).toFixed(0)}</div>
                        <div class="summary-label">Âπ≥Âùá‰ª∑Ê†º</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">¬•${(summary.price_stats.median_price / 100).toFixed(0)}</div>
                        <div class="summary-label">‰∏≠‰Ωç‰ª∑Ê†º</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${(summary.engagement_stats.total_fans / 10000).toFixed(1)}‰∏á</div>
                        <div class="summary-label">ÊÄªÁ≤â‰∏ùÊï∞</div>
                    </div>
                    <div class="summary-card">
                        <div class="summary-value">${summary.engagement_stats.avg_engagement_rate.toFixed(1)}%</div>
                        <div class="summary-label">Âπ≥Âùá‰∫íÂä®Áéá</div>
                    </div>
                </div>
            `;
            
            // ÊéíË°åÊ¶ú
            if (summary.top_regions && summary.top_regions.length > 0) {
                html += '<h3>üèÜ Âú∞Âå∫ÊéíË°åÊ¶ú</h3>';
                html += '<table class="ranking-table">';
                html += '<thead><tr><th>ÊéíÂêç</th><th>Âú∞Âå∫</th><th>ÂåªÁîüÊï∞Èáè</th><th>Âπ≥ÂùáËØÑÂàÜ</th><th>Âπ≥Âùá‰ª∑Ê†º</th></tr></thead>';
                html += '<tbody>';
                
                summary.top_regions.slice(0, 10).forEach((region, index) => {
                    const rankClass = index < 3 ? `rank-${index + 1}` : '';
                    html += `
                        <tr>
                            <td class="rank-number ${rankClass}">${index + 1}</td>
                            <td>${region.region}</td>
                            <td>${region.doctor_count}</td>
                            <td>${region.avg_score.toFixed(1)}</td>
                            <td>¬•${(region.avg_price / 100).toFixed(0)}</td>
                        </tr>
                    `;
                });
                
                html += '</tbody></table>';
            }
            
            return html;
        }

        // Ê∏≤ÊüìÊéíÂêçÊä•Âëä
        function renderRankingReport(report) {
            const rankings = report.data.rankings;
            if (!rankings || rankings.length === 0) {
                return '<p>ÊöÇÊó†ÊéíÂêçÊï∞ÊçÆ</p>';
            }
            
            let html = `
                <h3>üèÜ ÂåªÁîüÁªºÂêàÊéíÂêç (Top ${Math.min(rankings.length, 50)})</h3>
                <table class="ranking-table">
                    <thead>
                        <tr>
                            <th>ÊéíÂêç</th>
                            <th>ÂåªÁîü</th>
                            <th>Âú∞Âå∫</th>
                            <th>ÁßëÂÆ§</th>
                            <th>Á≤â‰∏ùÊï∞</th>
                            <th>ÁªºÂêàËØÑÂàÜ</th>
                            <th>ËØÑÂàÜÊûÑÊàê</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            rankings.slice(0, 50).forEach(ranking => {
                const doctor = ranking.doctor.doctor;
                const score = ranking.doctor.comprehensive_score;
                const components = ranking.score_components;
                const rankClass = ranking.rank <= 3 ? `rank-${ranking.rank}` : '';
                
                html += `
                    <tr>
                        <td class="rank-number ${rankClass}">${ranking.rank}</td>
                        <td>
                            <strong>${doctor.name}</strong><br>
                            <small>${doctor.title}</small>
                        </td>
                        <td>${doctor.region}</td>
                        <td>${doctor.department}</td>
                        <td>${doctor.total_fans.toLocaleString()}</td>
                        <td>
                            <div class="score-bar">
                                <div class="score-progress">
                                    <div class="score-fill" style="width: ${score}%"></div>
                                </div>
                                <div class="score-text">${score.toFixed(1)}</div>
                            </div>
                        </td>
                        <td>
                            <small>
                                ÂΩ±ÂìçÂäõ: ${components.influence_score.toFixed(1)}<br>
                                Ë¥®Èáè: ${components.quality_score.toFixed(1)}
                            </small>
                        </td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            return html;
        }

        // Ê∏≤ÊüìÂàÜÊûêÊä•Âëä
        function renderAnalysisReport(report) {
            const analysis = report.data.analysis;
            if (!analysis) return '<p>ÊöÇÊó†ÂàÜÊûêÊï∞ÊçÆ</p>';
            
            let html = '';
            
            // Áõ∏ÂÖ≥ÊÄßÂàÜÊûê
            if (analysis.correlations && analysis.correlations.length > 0) {
                html += '<div class="analysis-section">';
                html += '<h3>üìä Áõ∏ÂÖ≥ÊÄßÂàÜÊûê</h3>';
                
                analysis.correlations.forEach(corr => {
                    const strength = Math.abs(corr.correlation);
                    const strengthText = strength > 0.7 ? 'Âº∫Áõ∏ÂÖ≥' : strength > 0.3 ? '‰∏≠Á≠âÁõ∏ÂÖ≥' : 'Âº±Áõ∏ÂÖ≥';
                    const color = strength > 0.7 ? '#28a745' : strength > 0.3 ? '#ffc107' : '#6c757d';
                    
                    html += `
                        <div class="insight-item">
                            <strong>${corr.factor1} vs ${corr.factor2}</strong>
                            <div style="color: ${color}; font-weight: 600;">
                                Áõ∏ÂÖ≥Á≥ªÊï∞: ${corr.correlation.toFixed(3)} (${strengthText})
                            </div>
                            <p>${corr.description}</p>
                        </div>
                    `;
                });
                
                html += '</div>';
            }
            
            // ‰∏öÂä°Ê¥ûÂØü
            if (analysis.insights && analysis.insights.length > 0) {
                html += '<div class="analysis-section">';
                html += '<h3>üí° ‰∏öÂä°Ê¥ûÂØü</h3>';
                
                analysis.insights.forEach(insight => {
                    html += `<div class="insight-item">üìà ${insight}</div>`;
                });
                
                html += '</div>';
            }
            
            // Âª∫ËÆÆ
            if (analysis.recommendations && analysis.recommendations.length > 0) {
                html += '<div class="analysis-section">';
                html += '<h3>üíº ‰∏öÂä°Âª∫ËÆÆ</h3>';
                
                analysis.recommendations.forEach(recommendation => {
                    html += `<div class="recommendation-item">üí° ${recommendation}</div>`;
                });
                
                html += '</div>';
            }
            
            return html;
        }

        // Ëé∑ÂèñÊä•ÂëäÊ†áÈ¢ò
        function getReportTitle(reportType) {
            const titles = {
                'overview': 'üìä Êï∞ÊçÆÊ¶ÇËßàÊä•Âëä',
                'ranking': 'üèÜ ÂåªÁîüÊéíÂêçÊä•Âëä',
                'analysis': 'üîç Ê∑±Â∫¶ÂàÜÊûêÊä•Âëä',
                'comparison': '‚öñÔ∏è ÂØπÊØîÂàÜÊûêÊä•Âëä'
            };
            return titles[reportType] || 'üìà ÂàÜÊûêÊä•Âëä';
        }

        // ÂØºÂá∫Êä•Âëä
        async function exportReport(format) {
            if (!currentReport) {
                showError('ËØ∑ÂÖàÁîüÊàêÊä•Âëä');
                return;
            }

            try {
                if (format === 'csv') {
                    const filters = collectFilters();
                    const requestData = {
                        report_type: selectedReportType,
                        filters: filters,
                        weight_config_id: parseInt(document.getElementById('weight-config-select').value) || null,
                        export_format: 'csv'
                    };

                    const response = await fetch('/api/reports/export/csv', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify(requestData)
                    });

                    if (response.ok) {
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = `report_${selectedReportType}_${new Date().toISOString().slice(0, 10)}.csv`;
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        showSuccess('CSV Êä•ÂëäÂØºÂá∫ÊàêÂäüÔºÅ');
                    } else {
                        throw new Error('ÂØºÂá∫Â§±Ë¥•');
                    }
                } else if (format === 'pdf') {
                    showError('PDF ÂØºÂá∫ÂäüËÉΩÂç≥Â∞ÜÊé®Âá∫');
                } else {
                    // JSON Ê†ºÂºè
                    const dataStr = JSON.stringify(currentReport, null, 2);
                    const blob = new Blob([dataStr], { type: 'application/json' });
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `report_${selectedReportType}_${new Date().toISOString().slice(0, 10)}.json`;
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    window.URL.revokeObjectURL(url);
                    
                    showSuccess('JSON Êä•ÂëäÂØºÂá∫ÊàêÂäüÔºÅ');
                }
            } catch (error) {
                showError('ÂØºÂá∫Â§±Ë¥•: ' + error.message);
            }
        }

        // ÂàÜ‰∫´Êä•Âëä
        function shareReport() {
            if (!currentReport) {
                showError('ËØ∑ÂÖàÁîüÊàêÊä•Âëä');
                return;
            }

            // ÁîüÊàêÂàÜ‰∫´ÈìæÊé• (ËøôÈáåÂè™ÊòØÁ§∫‰æã)
            const shareUrl = `${window.location.origin}/reports.html?report=${currentReport.report_id}`;
            
            if (navigator.share) {
                navigator.share({
                    title: 'ÂåªÁîüÊäïÊîæÂàÜÊûêÊä•Âëä',
                    text: `Êü•Áúã${getReportTitle(currentReport.report_type)}`,
                    url: shareUrl
                });
            } else {
                // Â§çÂà∂Âà∞Ââ™Ë¥¥Êùø
                navigator.clipboard.writeText(shareUrl).then(() => {
                    showSuccess('ÂàÜ‰∫´ÈìæÊé•Â∑≤Â§çÂà∂Âà∞Ââ™Ë¥¥ÊùøÔºÅ');
                }).catch(() => {
                    prompt('Â§çÂà∂ÂàÜ‰∫´ÈìæÊé•:', shareUrl);
                });
            }
        }

        // Â∑•ÂÖ∑ÂáΩÊï∞
        function showError(message) {
            const errorDiv = document.createElement('div');
            errorDiv.className = 'error-message';
            errorDiv.textContent = message;
            
            const container = document.querySelector('.reports-container');
            container.insertBefore(errorDiv, container.firstChild);
            
            setTimeout(() => {
                if (errorDiv.parentNode) {
                    errorDiv.parentNode.removeChild(errorDiv);
                }
            }, 5000);
        }

        function showSuccess(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            
            const container = document.querySelector('.reports-container');
            container.insertBefore(successDiv, container.firstChild);
            
            setTimeout(() => {
                if (successDiv.parentNode) {
                    successDiv.parentNode.removeChild(successDiv);
                }
            }, 5000);
        }
    </script>
</body>
</html>
