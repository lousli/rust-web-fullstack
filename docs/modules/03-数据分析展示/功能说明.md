# 数据分析展示模块

## 模块概述
负责根据医生信息和权重配置计算综合评分，并提供多维度的数据分析和可视化展示功能。

## 功能需求

### 1. 评分计算功能
- 根据权重配置计算医生综合评分
- 支持单个医生详细评分分析
- 支持批量医生评分计算
- 提供评分计算历史记录

### 2. 数据分析功能
- 医生评分排名分析
- 不同维度的对比分析
- 地区/科室/机构的统计分析
- 账号性质的分布分析
- 趋势分析和预测

### 3. 数据可视化
- 医生评分雷达图
- 各项指标柱状图/折线图
- 评分分布直方图
- 地区/科室分析饼图
- 综合评分仪表盘

### 4. 数据筛选和排序
- 多条件组合筛选
- 自定义排序规则
- 评分区间筛选
- 时间范围筛选

## 数据结构

### 医生评分表 (doctor_scores)
```sql
CREATE TABLE doctor_scores (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    doctor_id INTEGER REFERENCES doctors(id),
    weight_config_id INTEGER REFERENCES weight_configs(id),
    cost_performance_score DECIMAL(5,2),    -- 性价比指数
    data_index_score DECIMAL(5,2),          -- 数据指数
    performance_score DECIMAL(5,2),         -- 医生表现力评分
    affinity_score DECIMAL(5,2),            -- 医生亲和力评分
    editing_score DECIMAL(5,2),             -- 剪辑水平评分
    video_quality_score DECIMAL(5,2),       -- 画面质量评分
    weighted_total_score DECIMAL(5,2),      -- 加权总分
    calculated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    notes TEXT                               -- 评分备注
);
```

### 评分计算历史表 (score_calculation_history)
```sql
CREATE TABLE score_calculation_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    calculation_batch_id VARCHAR(50),       -- 批次ID
    doctor_count INTEGER,                   -- 计算医生数量
    weight_config_id INTEGER REFERENCES weight_configs(id),
    calculation_type VARCHAR(20),           -- 计算类型（单个/批量/定时）
    calculated_by VARCHAR(100),             -- 计算人员
    calculated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    execution_time_ms INTEGER,              -- 执行时间（毫秒）
    success_count INTEGER,                  -- 成功计算数量
    error_count INTEGER                     -- 失败计算数量
);
```

## API 接口设计

### 后端接口

#### 1. 计算医生评分
```
POST /api/scores/calculate
Body: {
    "doctor_ids": [1, 2, 3],
    "weight_config_id": 1,
    "force_recalculate": false
}
```

#### 2. 获取医生评分列表
```
GET /api/scores
Query Parameters:
- page: 页码
- limit: 每页数量
- doctor_name: 医生姓名筛选
- department: 科室筛选
- region: 地区筛选
- account_type: 账号性质筛选
- min_score: 最低评分
- max_score: 最高评分
- sort_by: 排序字段（total_score, performance_score等）
- sort_order: 排序方向（asc, desc）
```

#### 3. 获取单个医生详细评分
```
GET /api/scores/doctor/{doctor_id}
Query Parameters:
- weight_config_id: 权重配置ID（可选，默认使用当前激活配置）
```

#### 4. 获取评分统计数据
```
GET /api/scores/statistics
Query Parameters:
- group_by: 分组字段（department, region, account_type）
- metric: 统计指标（avg, max, min, count）
```

#### 5. 获取评分分布数据
```
GET /api/scores/distribution
Query Parameters:
- score_field: 评分字段
- bucket_size: 区间大小
```

#### 6. 获取评分趋势数据
```
GET /api/scores/trends
Query Parameters:
- period: 时间周期（daily, weekly, monthly）
- start_date: 开始日期
- end_date: 结束日期
```

#### 7. 导出评分数据
```
GET /api/scores/export
Query Parameters:
- format: 导出格式（excel, csv, pdf）
- filters: 筛选条件（JSON格式）
```

## 前端界面设计

### 1. 评分分析主页面
```html
<!-- 评分分析主页面布局 -->
<div class="score-analysis-page">
    <!-- 头部统计卡片 -->
    <div class="stats-cards">
        <div class="stat-card">
            <h3>总医生数量</h3>
            <div class="stat-value">1,234</div>
        </div>
        <div class="stat-card">
            <h3>平均评分</h3>
            <div class="stat-value">85.6</div>
        </div>
        <div class="stat-card">
            <h3>最高评分</h3>
            <div class="stat-value">98.5</div>
        </div>
        <div class="stat-card">
            <h3>评分范围</h3>
            <div class="stat-value">45.2 - 98.5</div>
        </div>
    </div>
    
    <!-- 筛选和操作工具栏 -->
    <div class="toolbar">
        <div class="filters">
            <select id="department-filter">
                <option value="">全部科室</option>
            </select>
            <select id="region-filter">
                <option value="">全部地区</option>
            </select>
            <input type="range" id="score-range" min="0" max="100">
        </div>
        <div class="actions">
            <button class="btn-primary" id="calculate-scores">重新计算评分</button>
            <button class="btn-secondary" id="export-data">导出数据</button>
        </div>
    </div>
    
    <!-- 图表区域 -->
    <div class="charts-container">
        <div class="chart-panel">
            <h4>评分分布图</h4>
            <canvas id="score-distribution-chart"></canvas>
        </div>
        <div class="chart-panel">
            <h4>科室平均评分</h4>
            <canvas id="department-avg-chart"></canvas>
        </div>
        <div class="chart-panel">
            <h4>评分趋势图</h4>
            <canvas id="score-trend-chart"></canvas>
        </div>
        <div class="chart-panel">
            <h4>账号性质分布</h4>
            <canvas id="account-type-chart"></canvas>
        </div>
    </div>
    
    <!-- 医生评分表格 -->
    <div class="scores-table-container">
        <table id="scores-table" class="data-table">
            <thead>
                <tr>
                    <th>排名</th>
                    <th>医生姓名</th>
                    <th>科室</th>
                    <th>地区</th>
                    <th>机构</th>
                    <th>账号性质</th>
                    <th>综合评分</th>
                    <th>性价比</th>
                    <th>数据指数</th>
                    <th>表现力</th>
                    <th>亲和力</th>
                    <th>剪辑水平</th>
                    <th>画面质量</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="scores-table-body">
                <!-- 动态加载数据 -->
            </tbody>
        </table>
        <div class="pagination" id="scores-pagination"></div>
    </div>
</div>
```

### 2. 医生详细评分页面
```html
<!-- 医生详细评分页面 -->
<div class="doctor-detail-page">
    <div class="doctor-info-card">
        <h2 id="doctor-name">张医生</h2>
        <div class="doctor-basic-info">
            <span>科室: 心内科</span>
            <span>地区: 北京</span>
            <span>机构: 北京协和医院</span>
            <span>账号性质: 头部</span>
        </div>
    </div>
    
    <div class="score-analysis-section">
        <!-- 综合评分仪表盘 -->
        <div class="score-dashboard">
            <h3>综合评分</h3>
            <div class="gauge-chart" id="total-score-gauge"></div>
            <div class="score-value">85.6</div>
        </div>
        
        <!-- 各项指标雷达图 -->
        <div class="radar-chart-container">
            <h3>各项指标分析</h3>
            <canvas id="doctor-radar-chart"></canvas>
        </div>
        
        <!-- 指标对比柱状图 -->
        <div class="bar-chart-container">
            <h3>指标详细分析</h3>
            <canvas id="doctor-bar-chart"></canvas>
        </div>
    </div>
    
    <!-- 评分历史记录 -->
    <div class="score-history-section">
        <h3>评分历史</h3>
        <table class="history-table">
            <thead>
                <tr>
                    <th>计算时间</th>
                    <th>权重配置</th>
                    <th>综合评分</th>
                    <th>各项指标</th>
                </tr>
            </thead>
            <tbody id="score-history-body">
                <!-- 动态加载历史数据 -->
            </tbody>
        </table>
    </div>
</div>
```

### 3. 数据分析仪表盘
- 实时统计数据展示
- 多维度数据对比
- 趋势分析图表
- 异常数据预警

## 文件结构

### 后端文件结构
```
src/
├── handlers/
│   ├── scores.rs               # 评分相关处理器
│   └── analytics.rs            # 数据分析处理器
├── models/
│   ├── doctor_score.rs         # 医生评分模型
│   └── score_history.rs        # 评分历史模型
├── routes/
│   ├── scores.rs               # 评分相关路由
│   └── analytics.rs            # 分析相关路由
├── services/
│   ├── score_calculator.rs     # 评分计算服务
│   ├── analytics_service.rs    # 数据分析服务
│   └── export_service.rs       # 数据导出服务
└── utils/
    ├── chart_data.rs           # 图表数据处理
    └── statistics.rs           # 统计计算工具
```

### 前端文件结构
```
src/
├── pages/
│   ├── score-analysis/
│   │   ├── index.html          # 评分分析主页
│   │   ├── doctor-detail.html  # 医生详细评分页
│   │   └── dashboard.html      # 数据仪表盘
│   └── reports/
│       └── score-report.html   # 评分报告页面
├── components/
│   ├── charts/
│   │   ├── radar-chart.js      # 雷达图组件
│   │   ├── bar-chart.js        # 柱状图组件
│   │   ├── gauge-chart.js      # 仪表盘组件
│   │   └── trend-chart.js      # 趋势图组件
│   ├── filters/
│   │   ├── score-filter.js     # 评分筛选组件
│   │   └── date-range.js       # 日期范围组件
│   └── tables/
│       └── scores-table.js     # 评分表格组件
├── services/
│   ├── score-service.js        # 评分相关服务
│   ├── analytics-service.js    # 分析相关服务
│   └── export-service.js       # 导出相关服务
└── utils/
    ├── chart-config.js         # 图表配置
    ├── data-formatter.js       # 数据格式化
    └── color-palette.js        # 颜色配置
```

## 核心算法实现

### 1. 评分计算算法
```rust
// 评分计算核心算法
pub fn calculate_weighted_score(
    scores: &DoctorScores,
    weights: &WeightConfig,
) -> Result<f64, CalculationError> {
    let weighted_score = 
        scores.cost_performance_score * weights.cost_performance_weight / 100.0 +
        scores.data_index_score * weights.data_index_weight / 100.0 +
        scores.performance_score * weights.performance_weight / 100.0 +
        scores.affinity_score * weights.affinity_weight / 100.0 +
        scores.editing_score * weights.editing_weight / 100.0 +
        scores.video_quality_score * weights.video_quality_weight / 100.0;
    
    // 确保结果在有效范围内
    Ok(weighted_score.max(0.0).min(100.0))
}
```

### 2. 统计分析算法
```rust
// 统计分析核心算法
pub fn calculate_statistics(
    scores: &[DoctorScore],
    group_by: &str,
) -> Result<Vec<StatisticResult>, AnalysisError> {
    let mut results = Vec::new();
    let grouped_data = group_scores_by_field(scores, group_by)?;
    
    for (group_name, group_scores) in grouped_data {
        let avg_score = group_scores.iter().map(|s| s.weighted_total_score).sum::<f64>() 
                       / group_scores.len() as f64;
        let max_score = group_scores.iter().map(|s| s.weighted_total_score).fold(0.0, f64::max);
        let min_score = group_scores.iter().map(|s| s.weighted_total_score).fold(100.0, f64::min);
        
        results.push(StatisticResult {
            group_name,
            count: group_scores.len(),
            average: avg_score,
            maximum: max_score,
            minimum: min_score,
        });
    }
    
    Ok(results)
}
```

### 3. 趋势分析算法
```javascript
// 前端趋势分析算法
function analyzeTrend(scoreHistory) {
    const trendData = scoreHistory.map((item, index) => ({
        x: index,
        y: item.weighted_total_score,
        date: item.calculated_at
    }));
    
    // 线性回归计算趋势
    const n = trendData.length;
    const sumX = trendData.reduce((sum, point) => sum + point.x, 0);
    const sumY = trendData.reduce((sum, point) => sum + point.y, 0);
    const sumXY = trendData.reduce((sum, point) => sum + point.x * point.y, 0);
    const sumXX = trendData.reduce((sum, point) => sum + point.x * point.x, 0);
    
    const slope = (n * sumXY - sumX * sumY) / (n * sumXX - sumX * sumX);
    const intercept = (sumY - slope * sumX) / n;
    
    return {
        slope,
        intercept,
        trend: slope > 0 ? 'increasing' : slope < 0 ? 'decreasing' : 'stable',
        correlation: calculateCorrelation(trendData)
    };
}
```

## 数据可视化配置

### 1. 图表颜色配置
```javascript
const chartColors = {
    primary: '#3498db',
    secondary: '#2ecc71', 
    warning: '#f39c12',
    danger: '#e74c3c',
    info: '#9b59b6',
    success: '#27ae60',
    palette: [
        '#3498db', '#2ecc71', '#f39c12', '#e74c3c', 
        '#9b59b6', '#27ae60', '#e67e22', '#34495e'
    ]
};
```

### 2. 雷达图配置
```javascript
const radarChartConfig = {
    type: 'radar',
    data: {
        labels: ['性价比', '数据指数', '表现力', '亲和力', '剪辑水平', '画面质量'],
        datasets: [{
            label: '医生评分',
            data: [],
            backgroundColor: 'rgba(54, 162, 235, 0.2)',
            borderColor: 'rgba(54, 162, 235, 1)',
            pointBackgroundColor: 'rgba(54, 162, 235, 1)',
        }]
    },
    options: {
        scales: {
            r: {
                beginAtZero: true,
                max: 100,
                ticks: {
                    stepSize: 20
                }
            }
        }
    }
};
```

## 性能优化策略

### 1. 评分计算优化
- 批量计算减少数据库访问
- 评分结果缓存机制
- 异步计算长时间任务
- 增量计算策略

### 2. 数据查询优化
- 数据库索引优化
- 分页查询优化
- 查询结果缓存
- 数据预聚合

### 3. 前端性能优化
- 图表数据懒加载
- 虚拟滚动技术
- 数据分片渲染
- 图表动画优化

## 测试策略

### 1. 评分计算测试
- 不同权重配置的计算准确性
- 边界值计算测试
- 大批量数据计算性能测试

### 2. 数据分析测试
- 统计结果准确性验证
- 分组统计逻辑测试
- 趋势分析算法测试

### 3. 可视化测试
- 图表数据绑定测试
- 交互功能测试
- 响应式布局测试
