# 报表导出模块

## 模块概述
提供医生数据和评分分析结果的多格式导出功能，支持Excel、CSV、PDF等格式的报表生成和下载。

## 功能需求

### 1. 报表类型
- 医生基本信息报表
- 医生评分详细报表
- 评分统计分析报表
- 权重配置报表
- 数据变更历史报表

### 2. 导出格式
- **Excel格式** (.xlsx)
  - 支持多工作表
  - 数据格式化和样式
  - 图表嵌入
- **CSV格式** (.csv)
  - 标准分隔符格式
  - UTF-8编码支持
- **PDF格式** (.pdf)
  - 专业报表布局
  - 图表和表格混排
  - 分页和页眉页脚

### 3. 报表功能
- 自定义筛选条件导出
- 定时报表生成
- 报表模板管理
- 导出历史记录
- 批量导出功能

## 数据结构

### 导出任务表 (export_tasks)
```sql
CREATE TABLE export_tasks (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    task_name VARCHAR(200),                 -- 任务名称
    export_type VARCHAR(50),                -- 导出类型
    export_format VARCHAR(20),              -- 导出格式
    filter_conditions TEXT,                 -- 筛选条件(JSON)
    file_path VARCHAR(500),                 -- 文件路径
    file_size INTEGER,                      -- 文件大小(字节)
    status VARCHAR(20),                     -- 状态(pending/processing/completed/failed)
    progress INTEGER DEFAULT 0,             -- 进度百分比
    error_message TEXT,                     -- 错误信息
    created_by VARCHAR(100),                -- 创建人
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    started_at DATETIME,                    -- 开始时间
    completed_at DATETIME,                  -- 完成时间
    download_count INTEGER DEFAULT 0,       -- 下载次数
    expires_at DATETIME                     -- 过期时间
);
```

### 报表模板表 (report_templates)
```sql
CREATE TABLE report_templates (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    template_name VARCHAR(200) NOT NULL,    -- 模板名称
    template_type VARCHAR(50),              -- 模板类型
    template_config TEXT,                   -- 模板配置(JSON)
    columns_config TEXT,                    -- 列配置(JSON)
    style_config TEXT,                      -- 样式配置(JSON)
    is_default BOOLEAN DEFAULT false,       -- 是否默认模板
    created_by VARCHAR(100),
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## API 接口设计

### 后端接口

#### 1. 创建导出任务
```
POST /api/export/tasks
Body: {
    "export_type": "doctor_scores",
    "export_format": "excel",
    "template_id": 1,
    "filter_conditions": {
        "department": "心内科",
        "min_score": 80,
        "date_range": {
            "start": "2025-01-01",
            "end": "2025-06-01"
        }
    },
    "task_name": "心内科高分医生报表"
}
```

#### 2. 获取导出任务列表
```
GET /api/export/tasks
Query Parameters:
- page: 页码
- limit: 每页数量
- status: 任务状态筛选
- created_by: 创建人筛选
```

#### 3. 获取导出任务状态
```
GET /api/export/tasks/{task_id}
```

#### 4. 下载导出文件
```
GET /api/export/download/{task_id}
```

#### 5. 删除导出任务
```
DELETE /api/export/tasks/{task_id}
```

#### 6. 获取报表模板列表
```
GET /api/export/templates
Query Parameters:
- template_type: 模板类型
```

#### 7. 创建报表模板
```
POST /api/export/templates
Body: {
    "template_name": "标准医生评分报表",
    "template_type": "doctor_scores",
    "columns_config": [
        {"field": "name", "title": "医生姓名", "width": 120},
        {"field": "department", "title": "科室", "width": 100},
        {"field": "total_score", "title": "综合评分", "width": 100, "format": "decimal"}
    ],
    "style_config": {
        "header_color": "#3498db",
        "font_size": 12,
        "border": true
    }
}
```

#### 8. 快速导出接口
```
POST /api/export/quick
Body: {
    "export_type": "doctor_list",
    "export_format": "csv",
    "filter_conditions": {}
}
```

## 前端界面设计

### 1. 导出配置页面
```html
<!-- 导出配置界面 -->
<div class="export-config-page">
    <div class="export-wizard">
        <!-- 步骤指示器 -->
        <div class="steps-indicator">
            <div class="step active">1. 选择数据</div>
            <div class="step">2. 配置格式</div>
            <div class="step">3. 确认导出</div>
        </div>
        
        <!-- 步骤1: 数据选择 -->
        <div class="step-content" id="step-1">
            <h3>选择导出数据类型</h3>
            <div class="export-types">
                <label class="export-type-card">
                    <input type="radio" name="export_type" value="doctor_list">
                    <div class="card-content">
                        <h4>医生基本信息</h4>
                        <p>导出医生的基本信息数据</p>
                    </div>
                </label>
                <label class="export-type-card">
                    <input type="radio" name="export_type" value="doctor_scores">
                    <div class="card-content">
                        <h4>医生评分数据</h4>
                        <p>导出医生的详细评分信息</p>
                    </div>
                </label>
                <label class="export-type-card">
                    <input type="radio" name="export_type" value="score_statistics">
                    <div class="card-content">
                        <h4>评分统计报表</h4>
                        <p>导出评分统计分析结果</p>
                    </div>
                </label>
            </div>
            
            <!-- 筛选条件 -->
            <div class="filter-section">
                <h4>数据筛选条件</h4>
                <div class="filter-grid">
                    <div class="filter-item">
                        <label>科室</label>
                        <select id="department-filter" multiple>
                            <option value="">全部科室</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>地区</label>
                        <select id="region-filter" multiple>
                            <option value="">全部地区</option>
                        </select>
                    </div>
                    <div class="filter-item">
                        <label>评分范围</label>
                        <div class="score-range">
                            <input type="number" id="min-score" placeholder="最低分">
                            <span>至</span>
                            <input type="number" id="max-score" placeholder="最高分">
                        </div>
                    </div>
                    <div class="filter-item">
                        <label>时间范围</label>
                        <div class="date-range">
                            <input type="date" id="start-date">
                            <span>至</span>
                            <input type="date" id="end-date">
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- 步骤2: 格式配置 -->
        <div class="step-content" id="step-2" style="display: none;">
            <h3>配置导出格式</h3>
            
            <!-- 导出格式选择 -->
            <div class="format-selection">
                <label class="format-option">
                    <input type="radio" name="export_format" value="excel">
                    <div class="format-card">
                        <i class="icon-excel"></i>
                        <h4>Excel格式</h4>
                        <p>支持多工作表和格式化</p>
                    </div>
                </label>
                <label class="format-option">
                    <input type="radio" name="export_format" value="csv">
                    <div class="format-card">
                        <i class="icon-csv"></i>
                        <h4>CSV格式</h4>
                        <p>纯文本，易于处理</p>
                    </div>
                </label>
                <label class="format-option">
                    <input type="radio" name="export_format" value="pdf">
                    <div class="format-card">
                        <i class="icon-pdf"></i>
                        <h4>PDF格式</h4>
                        <p>专业报表格式</p>
                    </div>
                </label>
            </div>
            
            <!-- 模板选择 -->
            <div class="template-selection">
                <h4>选择报表模板</h4>
                <select id="template-select">
                    <option value="">使用默认模板</option>
                </select>
                <button class="btn-secondary" id="create-template">创建新模板</button>
            </div>
            
            <!-- 列配置 -->
            <div class="columns-config">
                <h4>自定义列配置</h4>
                <div class="columns-list" id="columns-list">
                    <!-- 动态生成列配置项 -->
                </div>
            </div>
        </div>
        
        <!-- 步骤3: 确认导出 -->
        <div class="step-content" id="step-3" style="display: none;">
            <h3>确认导出设置</h3>
            <div class="export-summary">
                <div class="summary-item">
                    <label>数据类型:</label>
                    <span id="summary-type"></span>
                </div>
                <div class="summary-item">
                    <label>导出格式:</label>
                    <span id="summary-format"></span>
                </div>
                <div class="summary-item">
                    <label>预计记录数:</label>
                    <span id="summary-count"></span>
                </div>
                <div class="summary-item">
                    <label>任务名称:</label>
                    <input type="text" id="task-name" placeholder="自动生成">
                </div>
            </div>
        </div>
        
        <!-- 操作按钮 -->
        <div class="wizard-actions">
            <button class="btn-secondary" id="prev-step" style="display: none;">上一步</button>
            <button class="btn-primary" id="next-step">下一步</button>
            <button class="btn-success" id="start-export" style="display: none;">开始导出</button>
        </div>
    </div>
</div>
```

### 2. 导出任务管理页面
```html
<!-- 导出任务管理页面 -->
<div class="export-tasks-page">
    <div class="page-header">
        <h2>导出任务管理</h2>
        <button class="btn-primary" id="new-export">新建导出</button>
    </div>
    
    <!-- 任务列表 -->
    <div class="tasks-container">
        <table class="tasks-table">
            <thead>
                <tr>
                    <th>任务名称</th>
                    <th>导出类型</th>
                    <th>格式</th>
                    <th>状态</th>
                    <th>进度</th>
                    <th>文件大小</th>
                    <th>创建时间</th>
                    <th>创建人</th>
                    <th>操作</th>
                </tr>
            </thead>
            <tbody id="tasks-table-body">
                <!-- 动态加载任务列表 -->
            </tbody>
        </table>
    </div>
    
    <!-- 任务状态模态框 -->
    <div class="modal" id="task-status-modal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>任务详情</h3>
                <button class="close-btn">&times;</button>
            </div>
            <div class="modal-body">
                <div class="task-progress">
                    <div class="progress-bar">
                        <div class="progress-fill" id="task-progress-fill"></div>
                    </div>
                    <div class="progress-text" id="task-progress-text">0%</div>
                </div>
                <div class="task-details" id="task-details">
                    <!-- 任务详细信息 -->
                </div>
            </div>
        </div>
    </div>
</div>
```

## 文件结构

### 后端文件结构
```
src/
├── handlers/
│   ├── export.rs               # 导出相关处理器
│   └── templates.rs            # 模板管理处理器
├── models/
│   ├── export_task.rs          # 导出任务模型
│   └── report_template.rs      # 报表模板模型
├── routes/
│   └── export.rs               # 导出相关路由
├── services/
│   ├── export_service.rs       # 导出服务
│   ├── excel_service.rs        # Excel导出服务
│   ├── csv_service.rs          # CSV导出服务
│   ├── pdf_service.rs          # PDF导出服务
│   └── template_service.rs     # 模板服务
└── utils/
    ├── file_manager.rs         # 文件管理工具
    └── progress_tracker.rs     # 进度追踪工具
```

### 前端文件结构
```
src/
├── pages/
│   └── export/
│       ├── index.html          # 导出配置页面
│       ├── tasks.html          # 任务管理页面
│       └── templates.html      # 模板管理页面
├── components/
│   ├── export-wizard.js        # 导出向导组件
│   ├── task-monitor.js         # 任务监控组件
│   └── template-editor.js      # 模板编辑组件
└── api/
    └── export.js               # 导出相关API
```

## 技术实现要点

### 1. Excel导出实现
```rust
use xlsxwriter::prelude::*;

pub async fn export_to_excel(
    data: &[DoctorScore],
    template: &ReportTemplate,
    file_path: &str,
) -> Result<(), ExportError> {
    let workbook = Workbook::new(file_path)?;
    let mut worksheet = workbook.add_worksheet(Some("医生评分数据"))?;
    
    // 设置表头样式
    let header_format = workbook.add_format()
        .set_bold()
        .set_bg_color(Color::Blue)
        .set_font_color(Color::White);
    
    // 写入表头
    for (col, column_config) in template.columns_config.iter().enumerate() {
        worksheet.write_string(0, col as u16, &column_config.title, Some(&header_format))?;
    }
    
    // 写入数据
    for (row, score) in data.iter().enumerate() {
        for (col, column_config) in template.columns_config.iter().enumerate() {
            let value = get_field_value(score, &column_config.field);
            worksheet.write(row as u32 + 1, col as u16, &value)?;
        }
    }
    
    workbook.close()?;
    Ok(())
}
```

### 2. PDF导出实现
```rust
use printpdf::*;

pub async fn export_to_pdf(
    data: &[DoctorScore],
    template: &ReportTemplate,
    file_path: &str,
) -> Result<(), ExportError> {
    let (doc, page1, layer1) = PdfDocument::new("医生评分报表", Mm(210.0), Mm(297.0), "Layer 1");
    let current_layer = doc.get_page(page1).get_layer(layer1);
    
    // 设置字体
    let font = doc.add_builtin_font(BuiltinFont::HelveticaBold)?;
    
    // 写入表头
    let mut y_position = Mm(280.0);
    current_layer.use_text("医生评分报表", 16, Mm(20.0), y_position, &font);
    
    // 写入表格数据
    y_position -= Mm(20.0);
    for score in data {
        // 写入数据行
        current_layer.use_text(&format!("{} - {}", score.doctor_name, score.total_score), 
                              12, Mm(20.0), y_position, &font);
        y_position -= Mm(10.0);
    }
    
    doc.save(&mut BufWriter::new(File::create(file_path)?))?;
    Ok(())
}
```

### 3. 导出进度追踪
```rust
pub struct ProgressTracker {
    task_id: String,
    total_items: usize,
    processed_items: usize,
}

impl ProgressTracker {
    pub async fn update_progress(&mut self, processed: usize) -> Result<(), Error> {
        self.processed_items = processed;
        let progress = (self.processed_items * 100) / self.total_items;
        
        // 更新数据库中的进度
        sqlx::query("UPDATE export_tasks SET progress = ? WHERE id = ?")
            .bind(progress as i32)
            .bind(&self.task_id)
            .execute(&self.db_pool)
            .await?;
        
        Ok(())
    }
}
```

## 报表模板系统

### 1. 模板配置结构
```json
{
    "template_name": "标准医生评分报表",
    "template_type": "doctor_scores",
    "columns_config": [
        {
            "field": "doctor_id",
            "title": "医生ID",
            "width": 100,
            "align": "center",
            "format": "text"
        },
        {
            "field": "name",
            "title": "医生姓名",
            "width": 120,
            "align": "left",
            "format": "text"
        },
        {
            "field": "total_score",
            "title": "综合评分",
            "width": 100,
            "align": "center",
            "format": "decimal",
            "precision": 2
        }
    ],
    "style_config": {
        "header_style": {
            "background_color": "#3498db",
            "font_color": "#ffffff",
            "font_bold": true
        },
        "row_style": {
            "alternate_color": "#f8f9fa",
            "border": true
        }
    }
}
```

## 测试用例

### 1. 功能测试
- 各种格式导出功能测试
- 大数据量导出性能测试
- 导出任务状态管理测试
- 模板系统功能测试

### 2. 边界测试
- 空数据导出测试
- 超大数据量导出测试
- 网络中断恢复测试
- 磁盘空间不足处理测试
