# 权重配置管理模块

## 模块概述
负责管理各个评分指标的权重配置，支持动态调整权重值并记录变更历史。

## 功能需求

### 1. 权重配置管理
- 配置各项指标的权重值
- 权重值范围验证（0-100%，总和必须为100%）
- 实时权重分配调整
- 权重预设模板管理

### 2. 权重历史记录
- 记录权重变更历史
- 变更人员和时间追踪
- 权重变更原因记录
- 历史版本回滚功能

### 3. 权重应用和计算
- 根据权重计算综合评分
- 权重变更对历史数据的影响分析
- 不同权重方案的对比分析

## 数据结构

### 权重配置表 (weight_configs)
```sql
CREATE TABLE weight_configs (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_name VARCHAR(100) NOT NULL,      -- 配置名称
    cost_performance_weight DECIMAL(5,2),   -- 性价比指数权重
    data_index_weight DECIMAL(5,2),         -- 数据指数权重
    performance_weight DECIMAL(5,2),        -- 医生表现力评分权重
    affinity_weight DECIMAL(5,2),           -- 医生亲和力评分权重
    editing_weight DECIMAL(5,2),            -- 剪辑水平评分权重
    video_quality_weight DECIMAL(5,2),      -- 画面质量评分权重
    is_active BOOLEAN DEFAULT false,         -- 是否为当前使用的配置
    created_by VARCHAR(100),                 -- 创建人
    created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
    description TEXT                         -- 配置说明
);
```

### 权重变更历史表 (weight_change_history)
```sql
CREATE TABLE weight_change_history (
    id INTEGER PRIMARY KEY AUTOINCREMENT,
    config_id INTEGER REFERENCES weight_configs(id),
    field_name VARCHAR(50) NOT NULL,        -- 变更的字段名
    old_value DECIMAL(5,2),                 -- 原值
    new_value DECIMAL(5,2),                 -- 新值
    change_reason TEXT,                     -- 变更原因
    changed_by VARCHAR(100),                -- 变更人
    changed_at DATETIME DEFAULT CURRENT_TIMESTAMP
);
```

## API 接口设计

### 后端接口

#### 1. 获取权重配置列表
```
GET /api/weight-configs
Query Parameters:
- page: 页码
- limit: 每页数量
- active_only: 仅显示激活的配置
```

#### 2. 获取当前激活的权重配置
```
GET /api/weight-configs/active
```

#### 3. 创建权重配置
```
POST /api/weight-configs
Body: {
    "config_name": "默认权重配置",
    "cost_performance_weight": 20.00,
    "data_index_weight": 20.00,
    "performance_weight": 15.00,
    "affinity_weight": 15.00,
    "editing_weight": 15.00,
    "video_quality_weight": 15.00,
    "description": "初始默认权重配置"
}
```

#### 4. 更新权重配置
```
PUT /api/weight-configs/{id}
Body: {同创建接口}
```

#### 5. 激活权重配置
```
POST /api/weight-configs/{id}/activate
Body: {
    "reason": "启用新的权重配置以提高评分准确性"
}
```

#### 6. 获取权重变更历史
```
GET /api/weight-configs/{id}/history
```

#### 7. 权重配置验证
```
POST /api/weight-configs/validate
Body: {权重配置对象}
```

#### 8. 删除权重配置
```
DELETE /api/weight-configs/{id}
```

## 前端界面设计

### 1. 权重配置主页面
- 当前激活配置显示
- 权重调整滑块/输入框
- 实时总和验证
- 权重可视化图表（饼图）

### 2. 权重配置管理页面
- 配置列表表格
- 新建配置按钮
- 配置操作按钮（编辑、激活、删除、复制）
- 配置历史查看

### 3. 权重调整界面设计
```html
<!-- 权重调整组件示例 -->
<div class="weight-config-panel">
    <h3>权重配置: <span id="config-name">默认配置</span></h3>
    
    <div class="weight-item">
        <label>性价比指数权重</label>
        <input type="range" min="0" max="100" value="20" id="cost-performance-weight">
        <input type="number" min="0" max="100" value="20" step="0.1">
        <span class="weight-percent">20%</span>
    </div>
    
    <div class="weight-item">
        <label>数据指数权重</label>
        <input type="range" min="0" max="100" value="20" id="data-index-weight">
        <input type="number" min="0" max="100" value="20" step="0.1">
        <span class="weight-percent">20%</span>
    </div>
    
    <!-- 其他权重项... -->
    
    <div class="weight-summary">
        <div class="total-weight">
            总权重: <span id="total-weight">100</span>%
            <span class="validation-status" id="validation-status">✓</span>
        </div>
        <div class="weight-chart">
            <canvas id="weight-pie-chart"></canvas>
        </div>
    </div>
    
    <div class="action-buttons">
        <button class="btn-primary" id="save-config">保存配置</button>
        <button class="btn-secondary" id="reset-config">重置</button>
        <button class="btn-info" id="preview-effect">预览效果</button>
    </div>
</div>
```

### 4. 权重预设模板
- 均衡型权重（各项权重相等）
- 数据导向型（数据指标权重较高）
- 表现力导向型（表现相关指标权重较高）
- 质量导向型（质量相关指标权重较高）

## 文件结构

### 后端文件结构
```
src/
├── handlers/
│   └── weight_configs.rs       # 权重配置处理器
├── models/
│   ├── weight_config.rs        # 权重配置模型
│   └── weight_history.rs       # 权重历史模型
├── routes/
│   └── weight_configs.rs       # 权重配置路由
└── utils/
    └── weight_validator.rs     # 权重验证工具
```

### 前端文件结构
```
src/
├── pages/
│   └── weight-config/
│       ├── index.html          # 权重配置主页
│       ├── management.html     # 配置管理页面
│       └── history.html        # 历史记录页面
├── components/
│   ├── weight-slider.js        # 权重滑块组件
│   ├── weight-chart.js         # 权重图表组件
│   └── weight-validator.js     # 前端权重验证
└── api/
    └── weight-configs.js       # 权重配置API
```

## 业务逻辑要点

### 1. 权重验证规则
- 所有权重值必须 >= 0
- 所有权重值必须 <= 100
- 所有权重值总和必须 = 100
- 权重值精度为小数点后2位

### 2. 权重变更流程
1. 用户调整权重值
2. 实时验证权重总和
3. 提示用户权重分配状态
4. 用户确认保存
5. 记录变更历史
6. 如需激活，则停用旧配置，激活新配置

### 3. 权重应用规则
- 系统只能有一个激活的权重配置
- 激活新配置时自动停用旧配置
- 权重变更不影响历史计算结果
- 新的评分计算使用最新权重

### 4. 权重预设模板
```javascript
const weightTemplates = {
    balanced: {
        name: "均衡型",
        weights: {
            cost_performance: 16.67,
            data_index: 16.67,
            performance: 16.67,
            affinity: 16.67,
            editing: 16.66,
            video_quality: 16.66
        }
    },
    dataFocused: {
        name: "数据导向型",
        weights: {
            cost_performance: 30,
            data_index: 30,
            performance: 10,
            affinity: 10,
            editing: 10,
            video_quality: 10
        }
    },
    performanceFocused: {
        name: "表现力导向型",
        weights: {
            cost_performance: 10,
            data_index: 10,
            performance: 30,
            affinity: 30,
            editing: 10,
            video_quality: 10
        }
    },
    qualityFocused: {
        name: "质量导向型",
        weights: {
            cost_performance: 10,
            data_index: 10,
            performance: 10,
            affinity: 10,
            editing: 30,
            video_quality: 30
        }
    }
};
```

## 技术实现要点

### 后端实现
- 权重配置的原子性操作
- 权重变更历史的完整记录
- 权重验证的服务端校验
- 配置激活的并发控制

### 前端实现
- 实时权重总和计算
- 拖拽式权重调整
- 权重可视化图表
- 权重变更动画效果

## 测试用例

### 功能测试
- 权重配置CRUD操作
- 权重验证规则测试
- 权重激活切换测试
- 权重历史记录测试

### 边界测试
- 权重值边界条件（0, 100）
- 权重总和验证（<100, >100, =100）
- 并发权重激活测试
