# 权重配置规则

## 1. 权重体系设计

### 1.1 权重分层结构

```
综合评价指数 (100%)
├── 账号性质权重 (建议: 25%)
├── 性价比权重 (建议: 30%)  
├── 数据趋势权重 (建议: 25%)
└── 内容质量权重 (建议: 20%)
    ├── 表现力权重 (6%)
    ├── 亲和力权重 (5%)
    ├── 剪辑水平权重 (5%)
    └── 画面质量权重 (4%)
```

### 1.2 默认权重配置

```rust
pub struct DefaultWeightConfig {
    // 一级权重 (总和必须为100%)
    pub account_type_weight: f32,          // 25% - 账号影响力
    pub cost_effectiveness_weight: f32,    // 30% - 投放性价比  
    pub data_trend_weight: f32,            // 25% - 数据趋势
    pub content_quality_weight: f32,       // 20% - 内容质量
    
    // 内容质量细分权重 (总和等于content_quality_weight)
    pub performance_weight: f32,           // 6%  - 医生表现力
    pub affinity_weight: f32,              // 5%  - 医生亲和力
    pub editing_weight: f32,               // 5%  - 剪辑水平
    pub video_quality_weight: f32,         // 4%  - 画面质量
}

impl Default for DefaultWeightConfig {
    fn default() -> Self {
        Self {
            account_type_weight: 25.0,
            cost_effectiveness_weight: 30.0,
            data_trend_weight: 25.0,
            content_quality_weight: 20.0,
            performance_weight: 6.0,
            affinity_weight: 5.0,
            editing_weight: 5.0,
            video_quality_weight: 4.0,
        }
    }
}
```

## 2. 权重配置场景

### 2.1 不同投放目标的权重建议

#### 2.1.1 成本敏感型投放
适用于预算有限，追求高性价比的投放场景。

```rust
pub fn cost_sensitive_weights() -> WeightConfig {
    WeightConfig {
        name: "成本敏感型".to_string(),
        account_type_weight: 15.0,
        cost_effectiveness_weight: 45.0,    // 提高性价比权重
        data_trend_weight: 25.0,
        performance_weight: 5.0,
        affinity_weight: 4.0,
        editing_weight: 3.0,
        video_quality_weight: 3.0,
    }
}
```

#### 2.1.2 影响力优先型投放
适用于品牌宣传，追求最大曝光的投放场景。

```rust
pub fn influence_priority_weights() -> WeightConfig {
    WeightConfig {
        name: "影响力优先型".to_string(),
        account_type_weight: 40.0,          // 提高账号性质权重
        cost_effectiveness_weight: 20.0,
        data_trend_weight: 25.0,
        performance_weight: 5.0,
        affinity_weight: 4.0,
        editing_weight: 3.0,
        video_quality_weight: 3.0,
    }
}
```

#### 2.1.3 内容质量型投放
适用于重视内容质量和专业性的投放场景。

```rust
pub fn quality_focused_weights() -> WeightConfig {
    WeightConfig {
        name: "内容质量型".to_string(),
        account_type_weight: 20.0,
        cost_effectiveness_weight: 25.0,
        data_trend_weight: 20.0,
        performance_weight: 10.0,           // 提高内容质量权重
        affinity_weight: 8.0,
        editing_weight: 9.0,
        video_quality_weight: 8.0,
    }
}
```

#### 2.1.4 增长潜力型投放
适用于挖掘新兴医生，重视成长性的投放场景。

```rust
pub fn growth_potential_weights() -> WeightConfig {
    WeightConfig {
        name: "增长潜力型".to_string(),
        account_type_weight: 15.0,
        cost_effectiveness_weight: 25.0,
        data_trend_weight: 40.0,            // 提高数据趋势权重
        performance_weight: 6.0,
        affinity_weight: 5.0,
        editing_weight: 5.0,
        video_quality_weight: 4.0,
    }
}
```

## 3. 权重验证规则

### 3.1 权重合法性检查

```rust
pub fn validate_weight_config(config: &WeightConfig) -> Result<(), Vec<String>> {
    let mut errors = Vec::new();
    
    // 检查权重范围
    let weights = [
        ("账号性质权重", config.account_type_weight),
        ("性价比权重", config.cost_effectiveness_weight),
        ("数据趋势权重", config.data_trend_weight),
        ("表现力权重", config.performance_weight),
        ("亲和力权重", config.affinity_weight),
        ("剪辑水平权重", config.editing_weight),
        ("画面质量权重", config.video_quality_weight),
    ];
    
    for (name, weight) in weights.iter() {
        if *weight < 0.0 || *weight > 100.0 {
            errors.push(format!("{} 必须在0-100之间，当前值: {}", name, weight));
        }
    }
    
    // 检查权重总和
    let total_weight = config.account_type_weight +
                       config.cost_effectiveness_weight +
                       config.data_trend_weight +
                       config.performance_weight +
                       config.affinity_weight +
                       config.editing_weight +
                       config.video_quality_weight;
    
    if (total_weight - 100.0).abs() > 0.1 {
        errors.push(format!("权重总和必须为100%，当前总和: {:.1}%", total_weight));
    }
    
    // 检查内容质量权重的合理性
    let content_quality_total = config.performance_weight +
                                config.affinity_weight +
                                config.editing_weight +
                                config.video_quality_weight;
    
    if content_quality_total > 50.0 {
        errors.push("内容质量相关权重总和不应超过50%".to_string());
    }
    
    if errors.is_empty() {
        Ok(())
    } else {
        Err(errors)
    }
}
```

### 3.2 权重合理性建议

```rust
pub fn suggest_weight_adjustments(config: &WeightConfig) -> Vec<String> {
    let mut suggestions = Vec::new();
    
    // 检查是否有权重过于集中的情况
    let max_weight = [
        config.account_type_weight,
        config.cost_effectiveness_weight,
        config.data_trend_weight,
        config.performance_weight + config.affinity_weight + 
        config.editing_weight + config.video_quality_weight,
    ].iter().fold(0.0f32, |acc, &x| acc.max(x));
    
    if max_weight > 60.0 {
        suggestions.push("建议避免单一指标权重过高（>60%），以保持评价的全面性".to_string());
    }
    
    // 检查权重分布是否均衡
    let weights = [
        config.account_type_weight,
        config.cost_effectiveness_weight,
        config.data_trend_weight,
    ];
    
    let avg_weight = weights.iter().sum::<f32>() / weights.len() as f32;
    let variance = weights.iter()
        .map(|w| (w - avg_weight).powi(2))
        .sum::<f32>() / weights.len() as f32;
    
    if variance > 400.0 {  // 标准差 > 20
        suggestions.push("主要指标权重分布差异较大，建议适当平衡".to_string());
    }
    
    // 具体权重建议
    if config.cost_effectiveness_weight < 20.0 {
        suggestions.push("性价比权重偏低，建议不少于20%以确保投放效率".to_string());
    }
    
    if config.account_type_weight < 15.0 {
        suggestions.push("账号性质权重偏低，建议不少于15%以保证基础影响力".to_string());
    }
    
    suggestions
}
```

## 4. 权重影响分析

### 4.1 权重敏感性分析

```rust
pub fn analyze_weight_sensitivity(
    doctor_data: &[DoctorData],
    base_config: &WeightConfig,
) -> WeightSensitivityReport {
    let mut report = WeightSensitivityReport::new();
    
    // 对每个权重进行±10%的调整，观察排名变化
    let adjustments = [-10.0, -5.0, 5.0, 10.0];
    
    for adjustment in adjustments.iter() {
        // 调整账号性质权重
        let mut test_config = base_config.clone();
        test_config.account_type_weight += adjustment;
        test_config.cost_effectiveness_weight -= adjustment; // 保持总和不变
        
        let ranking_change = calculate_ranking_change(doctor_data, base_config, &test_config);
        report.add_sensitivity_data("账号性质权重", *adjustment, ranking_change);
    }
    
    report
}

pub struct WeightSensitivityReport {
    pub sensitivity_data: HashMap<String, Vec<SensitivityPoint>>,
}

pub struct SensitivityPoint {
    pub adjustment: f32,
    pub avg_ranking_change: f32,
    pub max_ranking_change: i32,
    pub affected_doctors_count: i32,
}
```

### 4.2 权重优化建议

```rust
pub fn optimize_weights_for_goal(
    historical_data: &[InvestmentResult],
    optimization_goal: OptimizationGoal,
) -> WeightConfig {
    match optimization_goal {
        OptimizationGoal::MaximizeROI => {
            // 基于历史ROI数据，优化权重配置
            optimize_for_roi(historical_data)
        },
        OptimizationGoal::MinimizeRisk => {
            // 降低高风险医生的权重
            optimize_for_risk_reduction(historical_data)
        },
        OptimizationGoal::BalancePortfolio => {
            // 平衡各类医生的权重
            optimize_for_balance(historical_data)
        }
    }
}

pub enum OptimizationGoal {
    MaximizeROI,      // 最大化投资回报
    MinimizeRisk,     // 最小化投资风险
    BalancePortfolio, // 平衡投资组合
}
```

## 5. 权重配置管理

### 5.1 权重版本控制

```rust
pub struct WeightConfigVersion {
    pub id: i32,
    pub config: WeightConfig,
    pub version: String,
    pub created_by: String,
    pub created_at: DateTime<Utc>,
    pub is_active: bool,
    pub change_reason: String,
    pub performance_metrics: Option<PerformanceMetrics>,
}

pub struct PerformanceMetrics {
    pub avg_roi: f32,
    pub prediction_accuracy: f32,
    pub ranking_stability: f32,
    pub evaluation_period_days: i32,
}
```

### 5.2 权重A/B测试

```rust
pub struct WeightABTest {
    pub test_id: String,
    pub test_name: String,
    pub control_config: WeightConfig,
    pub test_config: WeightConfig,
    pub start_date: DateTime<Utc>,
    pub end_date: Option<DateTime<Utc>>,
    pub sample_size: i32,
    pub results: Option<ABTestResults>,
}

pub struct ABTestResults {
    pub control_performance: PerformanceMetrics,
    pub test_performance: PerformanceMetrics,
    pub statistical_significance: f32,
    pub recommendation: TestRecommendation,
}

pub enum TestRecommendation {
    AdoptTestConfig,
    KeepControlConfig,
    RunLongerTest,
    ModifyAndRetest,
}
```
