# API接口设计

## 1. API设计原则

### 1.1 RESTful设计规范

- 使用HTTP动词表示操作：GET（查询）、POST（创建）、PUT（更新）、DELETE（删除）
- 使用名词表示资源：doctors、weights、reports
- 统一的响应格式和错误处理
- 版本控制：所有API以 `/api/v1/` 开头

### 1.2 响应格式标准

```json
// 成功响应
{
    "success": true,
    "data": {},
    "message": "操作成功",
    "timestamp": "2024-06-01T10:00:00Z"
}

// 错误响应
{
    "success": false,
    "error": {
        "code": "VALIDATION_ERROR",
        "message": "数据验证失败",
        "details": {
            "field": "agency_price",
            "rejected_value": "-100",
            "message": "价格不能为负数"
        }
    },
    "timestamp": "2024-06-01T10:00:00Z"
}
```

## 2. 医生管理API

### 2.1 获取医生列表

```http
GET /api/v1/doctors
```

**查询参数:**
```
page: int = 1              # 页码
page_size: int = 20        # 每页数量
region: string             # 地区筛选
department: string         # 科室筛选
account_type: string       # 账号类型: head/middle/tail
min_score: float           # 最低综合评分
max_score: float           # 最高综合评分
sort_by: string = comprehensive_index  # 排序字段
sort_order: string = desc   # 排序顺序: asc/desc
search: string             # 搜索关键词（姓名、机构）
```

**响应示例:**
```json
{
    "success": true,
    "data": {
        "doctors": [
            {
                "id": "DOC0001",
                "name": "刘翔",
                "title": "主治医师",
                "region": "成都",
                "department": "内分泌科",
                "agency_name": "南鲸健康",
                "agency_price": 6439.0,
                "total_followers": 624222,
                "account_type": "middle",
                "comprehensive_index": 85.6,
                "cost_effectiveness_index": 78.2,
                "rank": 1
            }
        ],
        "pagination": {
            "page": 1,
            "page_size": 20,
            "total_count": 156,
            "total_pages": 8
        }
    }
}
```

### 2.2 获取医生详情

```http
GET /api/v1/doctors/{doctor_id}
```

**响应示例:**
```json
{
    "success": true,
    "data": {
        "id": "DOC0001",
        "name": "刘翔",
        "title": "主治医师",
        "region": "成都",
        "department": "内分泌科",
        "agency_name": "南鲸健康",
        "agency_price": 6439.0,
        "total_followers": 624222,
        "total_likes": 248036,
        "total_works": 702,
        "metrics": {
            "likes_7d": 3081,
            "followers_7d": 3518,
            "shares_7d": 317,
            "comments_7d": 1550,
            "works_7d": 9,
            "likes_15d": 3081,
            "followers_15d": 3518,
            "shares_15d": 317,
            "comments_15d": 1550,
            "works_15d": 9,
            "likes_30d": 3081,
            "followers_30d": 3518,
            "shares_30d": 317,
            "comments_30d": 1550,
            "works_30d": 9
        },
        "scores": {
            "performance_score": 8.5,
            "affinity_score": null,
            "editing_score": 6.4,
            "video_quality_score": 7.3,
            "scored_at": "2024-05-25T14:30:00Z"
        },
        "indicators": {
            "account_type": "middle",
            "account_type_score": 65.2,
            "cost_effectiveness_index": 78.2,
            "data_trend_index": 82.5,
            "growth_stability_index": 75.8,
            "content_quality_index": 73.0,
            "comprehensive_index": 85.6,
            "calculated_at": "2024-06-01T09:00:00Z"
        },
        "updated_at": "2024-06-01T08:30:00Z"
    }
}
```

### 2.3 批量导入医生数据

```http
POST /api/v1/doctors/import
```

**请求体:**
```json
{
    "doctors": [
        {
            "doctor_id": "DOC0002",
            "name": "张医生",
            "title": "副主任医师",
            "region": "北京",
            "department": "心内科",
            "agency_name": "医疗机构A",
            "agency_price": 8000,
            "total_followers": 350000,
            "total_likes": 180000,
            "total_works": 456,
            "likes_7d": 2500,
            "followers_7d": 1200,
            "shares_7d": 180,
            "comments_7d": 890,
            "works_7d": 5,
            "performance_score": 9.2,
            "editing_score": 7.8,
            "video_quality_score": 8.1
        }
    ],
    "overwrite_existing": false
}
```

**响应示例:**
```json
{
    "success": true,
    "data": {
        "total_records": 1,
        "success_count": 1,
        "failed_count": 0,
        "errors": [],
        "warnings": [
            "医生 DOC0002 缺少亲和力评分"
        ]
    }
}
```

### 2.4 更新医生信息

```http
PUT /api/v1/doctors/{doctor_id}
```

**请求体:**
```json
{
    "name": "刘翔",
    "title": "副主任医师",
    "agency_price": 7000,
    "performance_score": 9.0
}
```

### 2.5 删除医生

```http
DELETE /api/v1/doctors/{doctor_id}
```

## 3. 权重配置API

### 3.1 获取权重配置列表

```http
GET /api/v1/weights
```

**响应示例:**
```json
{
    "success": true,
    "data": {
        "configs": [
            {
                "id": 1,
                "name": "默认配置",
                "description": "系统默认的权重配置",
                "is_default": true,
                "created_at": "2024-05-01T10:00:00Z",
                "updated_at": "2024-05-01T10:00:00Z"
            },
            {
                "id": 2,
                "name": "成本敏感型",
                "description": "适用于预算有限的投放场景",
                "is_default": false,
                "created_at": "2024-05-15T14:20:00Z",
                "updated_at": "2024-05-20T09:30:00Z"
            }
        ],
        "current_config_id": 1
    }
}
```

### 3.2 获取权重配置详情

```http
GET /api/v1/weights/{config_id}
```

**响应示例:**
```json
{
    "success": true,
    "data": {
        "id": 1,
        "name": "默认配置",
        "description": "系统默认的权重配置",
        "account_type_weight": 25.0,
        "cost_effectiveness_weight": 30.0,
        "data_trend_weight": 25.0,
        "performance_weight": 6.0,
        "affinity_weight": 5.0,
        "editing_weight": 5.0,
        "video_quality_weight": 4.0,
        "is_default": true,
        "created_by": "system",
        "created_at": "2024-05-01T10:00:00Z",
        "updated_at": "2024-05-01T10:00:00Z"
    }
}
```

### 3.3 创建权重配置

```http
POST /api/v1/weights
```

**请求体:**
```json
{
    "name": "影响力优先型",
    "description": "适用于品牌宣传的投放场景",
    "account_type_weight": 40.0,
    "cost_effectiveness_weight": 20.0,
    "data_trend_weight": 25.0,
    "performance_weight": 5.0,
    "affinity_weight": 4.0,
    "editing_weight": 3.0,
    "video_quality_weight": 3.0
}
```

### 3.4 更新权重配置

```http
PUT /api/v1/weights/{config_id}
```

### 3.5 设置当前权重配置

```http
POST /api/v1/weights/{config_id}/activate
```

### 3.6 删除权重配置

```http
DELETE /api/v1/weights/{config_id}
```

## 4. 统计分析API

### 4.1 获取整体统计

```http
GET /api/v1/statistics/overview
```

**响应示例:**
```json
{
    "success": true,
    "data": {
        "total_doctors": 156,
        "head_account_count": 12,
        "middle_account_count": 45,
        "tail_account_count": 99,
        "avg_comprehensive_score": 72.5,
        "avg_cost_effectiveness": 68.2,
        "score_distribution": [
            {"score_range": "90-100", "count": 8, "percentage": 5.1},
            {"score_range": "80-90", "count": 25, "percentage": 16.0},
            {"score_range": "70-80", "count": 48, "percentage": 30.8},
            {"score_range": "60-70", "count": 42, "percentage": 26.9},
            {"score_range": "0-60", "count": 33, "percentage": 21.2}
        ],
        "region_distribution": [
            {"region": "北京", "count": 28, "avg_score": 75.2},
            {"region": "上海", "count": 22, "avg_score": 73.8},
            {"region": "成都", "count": 18, "avg_score": 71.5}
        ],
        "department_distribution": [
            {"department": "内分泌科", "count": 35, "avg_score": 74.1},
            {"department": "心内科", "count": 28, "avg_score": 72.9},
            {"department": "呼吸科", "count": 25, "avg_score": 70.8}
        ]
    }
}
```

### 4.2 获取排行榜

```http
GET /api/v1/statistics/ranking
```

**查询参数:**
```
type: string = comprehensive  # 排行类型: comprehensive/cost_effectiveness/data_trend
limit: int = 50              # 返回数量限制
region: string               # 地区筛选
department: string           # 科室筛选
```

### 4.3 获取趋势分析

```http
GET /api/v1/statistics/trends
```

**查询参数:**
```
period: string = 30d         # 时间周期: 7d/15d/30d
metric: string = comprehensive # 指标类型
doctor_ids: string[]         # 特定医生ID列表
```

## 5. 系统配置API

### 5.1 获取系统配置

```http
GET /api/v1/config/system
```

**响应示例:**
```json
{
    "success": true,
    "data": {
        "account_head_threshold": 500000,
        "account_middle_threshold": 100000,
        "cost_base_price": 5000.0,
        "trend_weight_7d": 0.5,
        "trend_weight_15d": 0.3,
        "trend_weight_30d": 0.2
    }
}
```

### 5.2 更新系统配置

```http
PUT /api/v1/config/system
```

**请求体:**
```json
{
    "account_head_threshold": 600000,
    "cost_base_price": 5500.0
}
```

## 6. 数据导出API

### 6.1 导出医生数据

```http
POST /api/v1/export/doctors
```

**请求体:**
```json
{
    "format": "excel",           # excel/csv
    "filters": {
        "region": "北京",
        "min_score": 70.0
    },
    "fields": [
        "basic_info",
        "metrics",
        "scores",
        "indicators"
    ]
}
```

**响应:**
```json
{
    "success": true,
    "data": {
        "download_url": "/api/v1/files/download/doctors_20240601.xlsx",
        "expires_at": "2024-06-02T10:00:00Z"
    }
}
```

### 6.2 导出报表

```http
POST /api/v1/export/reports
```

## 7. 计算引擎API

### 7.1 重新计算指标

```http
POST /api/v1/calculate/indicators
```

**请求体:**
```json
{
    "doctor_ids": ["DOC0001", "DOC0002"],  # 可选，不提供则计算所有
    "weight_config_id": 1,                 # 可选，不提供则使用当前配置
    "force_recalculate": false             # 是否强制重新计算
}
```

### 7.2 预览权重变化影响

```http
POST /api/v1/calculate/preview
```

**请求体:**
```json
{
    "weight_config": {
        "account_type_weight": 30.0,
        "cost_effectiveness_weight": 35.0,
        "data_trend_weight": 20.0,
        "performance_weight": 5.0,
        "affinity_weight": 4.0,
        "editing_weight": 3.0,
        "video_quality_weight": 3.0
    },
    "doctor_ids": ["DOC0001", "DOC0002"]   # 可选
}
```

**响应示例:**
```json
{
    "success": true,
    "data": {
        "doctors": [
            {
                "doctor_id": "DOC0001",
                "current_score": 85.6,
                "new_score": 83.2,
                "score_change": -2.4,
                "current_rank": 1,
                "new_rank": 3,
                "rank_change": -2
            }
        ],
        "summary": {
            "total_affected": 156,
            "avg_score_change": -1.2,
            "max_rank_change": 15
        }
    }
}
```

## 8. 错误码定义

```rust
pub enum ApiErrorCode {
    // 通用错误 (1000-1999)
    InvalidRequest = 1001,      // 请求格式错误
    ValidationError = 1002,     // 数据验证失败
    InternalError = 1003,       // 服务器内部错误
    
    // 认证授权错误 (2000-2999)
    Unauthorized = 2001,        // 未授权
    Forbidden = 2002,          // 禁止访问
    
    // 业务错误 (3000-3999)
    DoctorNotFound = 3001,     // 医生不存在
    WeightConfigNotFound = 3002, // 权重配置不存在
    DuplicateDoctor = 3003,    // 医生ID重复
    InvalidWeightSum = 3004,   // 权重总和不为100%
    
    // 数据处理错误 (4000-4999)
    ImportDataError = 4001,    // 导入数据错误
    CalculationError = 4002,   // 计算错误
    ExportError = 4003,        // 导出错误
}
```
